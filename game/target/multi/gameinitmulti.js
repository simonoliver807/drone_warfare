define(["oimo","v3d","multi/gamecore","asteroid","planetex","setRespawn"],function(e,r,n,s,a,o){"use strict";return function(){var t=0,i=new r.View,d=new n,l=new s;l.initMat();var p=new a;p.initMat();var c,m,h,y,u=0,v=2,g=8,f=!1,x=0,b=1,w=1,D=[],z=0,M=[],B=0,_=5;new e.Vec3(0,1,0),i.w/2,i.h/2;y=new e.Vec3(0,0,0);var j,q,V,E,I,S,G,R,P=(document.getElementById("container"),[]),O=new e.Vec3,T=i.tvec(0,0,0),k=i.tvec(0,0,0),C=document.getElementById("mapms1"),F=document.getElementById("mapms2"),L=document.getElementById("gmap"),H=1,A=1,N=i.tvec(0,0,0),U=i.tvec(0,0,0),Q=0,W=0,J=[],X=0,K=0,Y=0,Z=0,$=0,ee=[],re=1,ne=0,se=0,ae=0,oe=[],te=60,ie=[],de=1,le=0,pe=0,ce=0,me=[],he=[],ye=.05,ue=-.1,ve=i.tvec(0,0,0),ge={pos:[]},fe=0,xe=0,be=new Date;return{createWorld:function(r){c=new e.World(r,v,g,f),c.worldscale(100),c.gravity=new e.Vec3(0,0,0),i.setWorld(c),d.start(),z=0,i.addPhaser=function(r,n){return D[D.length]=new e.Body(r),M[M.length]=n,D[D.length-1]},h=0,m=0,j=1,Z=100,V=this;for(var n=0;n<400;n++){var s=new e.Vec3;if(n%2){var a=[1,1,1],o=this.randMinMax(0,2);a[o]=-1,s.set(10*Math.random()*a[0],10*Math.random()*a[1],10*Math.random()*a[2])}else s.set(10*Math.random(),10*Math.random(),10*Math.random());he.push(s)}},render:function(){if(setTimeout(V.render,16),99===r.ms1_1arrpos&&Z>0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){Z--;var n=b+1;d.startgame=0,document.getElementById("level"+n+"Img").style.display="block"}if(0==Z&&V.levelGen(0),Z<0&&Z++,Z==-1&&(V.levelGen(1),d.startgame=0),x+=1e-5,!t&&r.startRender==ne&&d.startgame){if(d.respawn.restart&&D[0].r1>0){d.respawn.restart=0;var s;d.respawn.firepx?(s="planetary devastation",V.planetex()):s=G?"player 2 is toast":"player 1 is toast",document.getElementById("respawntxt").innerHTML=s,D[0].r1=0,V.handlerespawn(),d.respawning=1}2===d.startgame&&(G=d.gcd("host"),G&&(document.getElementById("respawntxt").innerHTML="delay for player 2"),d.startgame=0),de&&(V.threejsrender(),de=0);var a=[];if(ie=[],c.step(),se<te&&se!=-1?se+=.1:se=0,0!=re&&(re.ms1&&3!==b&&D[re.ms1].body.setupMass(2),re.ms2&&D[re.ms2].body.setupMass(2),re=0,document.getElementById("loadingScreen").style.display="none",w&&(document.getElementById("level1Img").style.display="block",ae++)),ae>0&&ae<100&&ae++,100===ae&&(document.getElementById("level1Img").style.display="none",document.getElementById("respawntxt").innerHTML=""),10==j?j=0:j+=1,!h){re={ms1:0,ms2:0};for(var o=i.tvec(),m=0,v=0;v<D.length;v++){for(var g=0;g<i.scene.children.length;g++){if(D[v].name==i.scene.children[g].name&&"player2"!=D[v].name){if(M.push(i.scene.children[g]),"shp1"==D[v].name&&w){var f=new e.Body({type:"sphere",size:[5,5,5],pos:[20,0,-100],move:!1,world:c,color:16777215,wireframe:"false",name:"player2",transparent:"true",opacity:0});f.body.sleep(),D.splice(v+1,0,f),z+=1;for(var _=i.scene.children[g].clone(),R=i.scene.children[g].children.length;R--;)if("material_1"==i.scene.children[g].children[R].material.name)var J=R;_.children[J].material=i.scene.children[g].children[J].material.clone();var K=i.glowmesh.clone();_.position.set(20,0,-100),_.name="player2",_.add(K),K.position.z+=500,K.material=i.glowmesh.material.clone(),K.name="pl2glowmesh",i.scene.add(_),M.push(_),M[M.length-1].userData.tquat=i.tquat(),M[M.length-1].userData.pquat=i.tquat();var Y=i.newTexture("images/cpv/ed1apl2.gif");r.bincam||(i.scene.children[g].visible=!1);for(var R=i.scene.children[g].children.length;R--;)if("material_1"==i.scene.children[g].children[R].material.name)var J=R;G?(_.children[J].material.map=Y,_.children[J].material.needsUpdate=!0):(D[0].body.position.set(.2,0,-1),M[0].position.set(20,0,-100),D[1].body.position.set(0,0,0),D[1].body.sleepPosition.set(0,0,0),M[1].position.set(0,0,0),i.scene.children[g].children[J].material.map=Y,i.scene.children[g].children[J].material.needsUpdate=!0)}if("ms1"==D[v].name||"ms2"==D[v].name){var ce=i.msla(D[v].body);D[v].body.setQuaternion(ce),w&&(i.scene.add(i.addPlane("engineGlow")),i.eg=i.scene.children[i.scene.children.length-1]),"ms1"==D[v].name?re.ms1=v:re.ms2=v}break}D[v].name!=i.scene.children[g].name||"player2"!=D[v].name||w||M.push(i.scene.children[g]);var be=ee.indexOf(D[v].name);if("planets"==i.scene.children[g].name&&be!=-1&&M.push(i.scene.children[g].children[be]),"drones"==i.scene.children[g].name&&(i.dronenum=g),"containerMesh"==i.scene.children[g].name)var we=g;"ms1"==i.scene.children[g].name&&(i.ms1arrpos=g),"ms2"==i.scene.children[g].name&&(i.ms2arrpos=g),"ms1_1"==i.scene.children[g].name&&(r.ms1_1arrpos=g),"ms2_1"==i.scene.children[g].name&&oe.indexOf("ms2")!=-1&&(r.ms2_1arrpos=g)}D[v].name.match("astgroup")&&(M.push(r.asteroids.children[m]),m++)}i.scene.children[i.ms1arrpos].children[0].add(r.ms1phaser),o.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position),Q=o.length(),Q-=$,i.ms1pos.set(i.scene.children[i.ms1arrpos].position.x,i.scene.children[i.ms1arrpos].position.y,i.scene.children[i.ms1arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms1arrpos]),i.ms2arrpos&&(i.scene.children[i.ms2arrpos].children[0].add(r.ms2phaser),o.subVectors(i.planetpos,i.scene.children[i.ms2arrpos].position),W=o.length(),W-=$,i.ms2pos.set(i.scene.children[i.ms2arrpos].position.x,i.scene.children[i.ms2arrpos].position.y,i.scene.children[i.ms2arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms2arrpos])),r.raycastarr.push(i.scene.children[i.dronenum]);for(var g=0;g<r.asteroids.length;g++)r.asteroids[g];for(var g=1;g<i.scene.children[i.dronenum].children.length;g++)M.push(i.scene.children[i.dronenum].children[g]);i.containerMesh=i.scene.children[we],i.controls.target=i.containerMesh.position,h=i.scene.children[we],B=M.length,w&&d.setply1ply2(D[0],D[1],M[1],D)}if(r.exdrone3.userData.active){for(var g=r.exdrone3.children.length-1;g>0;)V.expartfunc(r.exdrone3.children[g].position),r.exdrone3.children[g].geometry.dispose(),r.exdrone3.children[g].material.materials[0].dispose(),r.exdrone3.children[g].material.materials[1].dispose(),r.exdrone3.remove(r.exdrone3.children[g]),g--;r.exdrone3.userData.active=!1}if(r.exdrone2.userData.active){for(var g=r.exdrone2.children.length-1;g>0;){var De=r.exdrone3.children[0].clone();De.position.set(r.exdrone2.children[g].position.x,r.exdrone2.children[g].position.y,r.exdrone2.children[g].position.z),De.quaternion.set(r.exdrone2.children[g].quaternion.x,r.exdrone2.children[g].quaternion.y,r.exdrone2.children[g].quaternion.z,r.exdrone2.children[g].quaternion.w),De.visible=!0,r.exdrone3.children.push(De),r.exdrone3.userData.active=!0,r.exdrone2.children[g].geometry.dispose(),r.exdrone2.children[g].material.materials[0].dispose(),r.exdrone2.children[g].material.materials[1].dispose(),r.exdrone2.remove(r.exdrone2.children[g]),g--}r.exdrone2.userData.active=!1}if(r.exdrone1.userData.active){for(var g=r.exdrone1.children.length-1;g>0;){var De=r.exdrone2.children[0].clone();De.position.set(r.exdrone1.children[g].position.x,r.exdrone1.children[g].position.y,r.exdrone1.children[g].position.z),De.quaternion.set(r.exdrone1.children[g].quaternion.x,r.exdrone1.children[g].quaternion.y,r.exdrone1.children[g].quaternion.z,r.exdrone1.children[g].quaternion.w),De.visible=!0,r.exdrone2.children.push(De),r.exdrone2.userData.active=!0,r.exdrone1.children[g].geometry.dispose(),r.exdrone1.children[g].material.materials[0].dispose(),r.exdrone1.children[g].material.materials[1].dispose(),r.exdrone1.remove(r.exdrone1.children[g]),g--}r.exdrone1.userData.active=!1}for(var ze,Me,Be="shp1",_e="dphaser",je=c.contacts;null!==je;)null!=je.body1&&null!=je.body2&&(ze=je.body1.name||" ",Me=je.body2.name||" ",(ze==Be&&Me==_e||Me==Be&&ze==_e)&&(D[0].r1-=1,0===D[0].r1&&V.handlerespawn())),je=je.next;for(var g=0;g<r.grouppart.children.length;g++)if(x-r.grouppart.children[g].userData.timecreated>8e-4)r.grouppart.children[g].geometry.dispose(),r.grouppart.children[g].material.dispose(),r.grouppart.remove(r.grouppart.children[g]);else{for(var qe=r.grouppart.children[g].geometry.vertices,Ve=0;Ve<qe.length;Ve++)r.grouppart.children[g].geometry.vertices[Ve].x+=10*Math.random(),r.grouppart.children[g].geometry.vertices[Ve].y+=10*Math.random(),r.grouppart.children[g].geometry.vertices[Ve].z+=10*Math.random();r.grouppart.children[g].geometry.verticesNeedUpdate=!0}for(var g=me.length;g--;)if(x-me[g].userData.timecreated>8e-4){for(var Ee=me[g].children,Ie=Ee.length;Ie--;)Ee[Ie].material.dispose,Ee[Ie].geometry.dispose,me[g].remove(Ee[Ie]);i.scene.remove(me[g]),me.splice(g,1)}else for(var Ee=me[g].children,Ve=0;Ve<Ee.length;Ve++)Ee[Ve].position.x+=he[Ve].x,Ee[Ve].position.y+=he[Ve].y,Ee[Ve].position.z+=he[Ve].z;for(var Se,Ge,g=D.length;g--;){if(Ge=D[g],Se=M[g],i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value>u&&Z>0&&(d.respawn.firepx=1,V.planetex(),V.handlerespawn()),Se.name.match("ast")){if(Se.userData.atbd){i.playastex();var Re;if(Re="Group"==Se.type?l.breakDown(Se,Ge):0)for(var Pe=0;Pe<Re.length;Pe++){r.asteroids.add(Re[Pe]),D[z]=new e.Body({move:!0,name:Re[Pe].name,noSleep:!0,size:[30,30,30],pos:[Re[Pe].position.x,Re[Pe].position.y,Re[Pe].position.z],type:"cylinder",world:c}),z++,M.push(Re[Pe]),r.raycastarr.push(Re[Pe]);var Oe=Math.random();if(Pe&&(Oe*=-1),D[z-1].body.linearVelocity.set(Oe,Oe,Oe),D[z-1].body.newRotation.set(Oe,Oe,Oe),1===Se.children.length){var Te=Se.children[0];Te.position.set(Se.x,Se.y,Se.z),i.scene.add(Te),i.scene.remove(Se),M[g]=Te,Ge.name=Se.name,r.asteroids.add(M[g])}}if(0===Re){D.splice(g,1),M.splice(g,1),Se.geometry.dispose(),Se.material.dispose(),r.asteroids.remove(Se);for(var ke=0;ke<r.raycastarr.length;ke++)r.raycastarr[ke].name==Se.name&&r.raycastarr.splice(ke,1);z-=1,c.removeRigidBody(Ge.body);var Ce=p.create();Ce.position.copy(Se.position),Ce.name="pex",Ce.userData.timecreated=x,i.scene.add(Ce),me.push(Ce);var Fe=i.scene.children[r.mesharrpos.gs].children[0].clone();Fe.position.copy(Se.position),Fe.visible=!0,Fe.userData.timealive=0,i.scene.children[r.mesharrpos.gs].add(Fe)}}if(!i.boxworld.containsPoint(Se.position)){var Le=Ge.body.position;Le.multiplyScalar(-1);for(var He=["x","y","z"],Ae=3;Ae--;)(Le[He[Ae]]>150||Le[He[Ae]]<-150)&&(Le[He[Ae]]<0?Le[He[Ae]]=-149:Le[He[Ae]]=149);Se.position.copy(Le).multiplyScalar(100)}}if("phaser"!=Se.name&&"dphaser"!=Se.name||(Se.userData.timealive?(x-Se.userData.timealive>.006&&"dphaser"==Se.name&&a.push(D[g].body.shapes.id),x-Se.userData.timealive>615e-6&&"phaser"==Se.name&&a.push(D[g].body.shapes.id)):Se.userData.timealive=x),Se.userData.tbd<0&&(Se.userData.tbd+=1,0===Se.userData.tbd&&Ge.disabled&&(Ge.disabled=0)),!Ge.getSleep()&&(Se.position.copy(Ge.getPosition()),Se.quaternion.copy(Ge.getQuaternion()),"shp1"==Ge.name)){y.set(h.position.x,h.position.y,h.position.z),h.position.set(Se.position.x,Se.position.y,Se.position.z);var Ne=h.position.x-y.x,Ue=h.position.y-y.y,Qe=h.position.z-y.z;i.camera.position.x+=Ne,i.camera.position.y+=Ue,i.camera.position.z+=Qe}if(se>=te)for(var We=1;We;)"drone"!=D[We].name||D[We].ld||D[We].nrtm||(G?D[We].ld=1:D[We].ld=2,D[We].nrtm=1,ie.push({id:D[We].id+"6666",ld:D[We].ld,body:{position:{x:D[We].body.position.x,y:D[We].body.position.y,z:D[We].body.position.z},linearVelocity:{x:0,y:0,z:0}}}),We=0,se=0),We==D.length-1&&(We=0,se=-1),We>0&&We<D.length&&(We+=1);if(a.indexOf(Ge.body.shapes.id)!=-1||1==Se.userData.tbd||Ge.tbd)if(fe=0,Ge.tbd&&(Se.userData.tbd=1,fe=1),Se.userData.tbd&&!Ge.tbd&&(ie.push({id:Ge.id+"9999",ld:Ge.ld,body:{position:{x:Ge.body.position.x,y:Ge.body.position.y,z:Ge.body.position.z},linearVelocity:{x:0,y:0,z:0}}}),xe++),Ge.tbd&&(Ge.tbd=0,(G&&1===Ge.ld||!G&&2===Ge.ld)&&Ge.nrtm&&ie.push({id:Ge.id+"7777",ld:Ge.ld,body:{position:{x:Ge.body.position.x,y:Ge.body.position.y,z:Ge.body.position.z},linearVelocity:{x:0,y:0,z:0}}})),Se.userData.tbd&&(ve.subVectors(h.position,Se.position),ve.x>2e3||ve.y>2e3||ve.z>2e3?i.playDroneEx(1):i.playDroneEx(0)),Ge.ld&&Ge.nrtm)if(G&&1===Ge.ld||!G&&2===Ge.ld){"ms1"==Ge.ms&&(ge.pos=[i.ms1pos.x,i.ms1pos.y,i.ms1pos.z]),"ms2"==Ge.ms&&(ge.pos=[i.ms2pos.x,i.ms2pos.y,i.ms2pos.z]),V.loadExdrone(Se);var Je=V.dronePos(ge);Ge.body.position.set(Je[0]/100,Je[1]/100,Je[2]/100),Se.userData.tbd=-5}else V.loadExdrone(Se),Ge.body.position.set(2e4,1e4,1e4),fe?Se.userData.tbd=-5:(Se.userData.tbd=-300,Ge.disabled=1);else{D.splice(g,1),M.splice(g,1);var Xe=Se.geometry,Re=Se.material;Xe.dispose(),"undefined"==typeof Re.dispose?(V.loadExdrone(Se),Re.materials[0].dispose(),Re.materials[1].dispose(),i.scene.children[i.dronenum].remove(Se),X-=1,z-=1):(Re.dispose(),"phaser"==Se.name&&i.scene.children[r.mesharrpos.phasers].remove(Se),(Se.name="dphaser")&&(i.scene.children[r.mesharrpos.dphasers].remove(Se),z--,B--)),c.removeRigidBody(Ge.body)}if(x-Se.userData.color>5e-4&&x-Se.userData.color<.001&&(Se.children[0].material.color.setRGB(.64,.64,.64),Se.userData.color=0),"ms1"==Se.name||"ms2"==Se.name){if((3===b||6===b)&&"ms1"==Se.name){Ge.body.position.x>50&&(ye=-.05,ue=-.1),Ge.body.position.x<-50&&(ye=.05,ue=-.1),N.copy(Ge.body.position),Ge.body.position.x+=ye,Ge.body.position.y=0,Ge.body.position.z=(ue*Math.pow(Ge.body.position.x,2)+50)/2;var ce=i.msla(Ge.body);Ge.body.setQuaternion(ce);var Ke=4,o=i.tvec();for(Q=o.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position).length(),Q-=$,U.subVectors(N,Ge.body.position),i.ms1pos.copy(Se.position);Ke--;)r.ms1phaser.children[Ke]&&(20*r.ms1phaser.children[Ke].scale.z<Q?(r.ms1phaser.children[Ke].scale.z+=.5,r.ms1phaser.children[Ke].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0,20*r.ms1phaser.children[Ke].scale.z>Q&&(r.ms1phaser.children[Ke].scale.z-=.5,r.ms1phaser.children[Ke].position.z-=5))}var Ye=d.gcd("ms1y");if(Ye.y&&(i.ms1y.y=1),le=Ye.t,"ms1"==Ge.name)"ms1_4"!=Se.userData.msname&&(q=C,i.ms1y.y&&(Se.children[0].material.color.setRGB(255,255,0),Se.userData.color=x,i.ms1y.y=0,le>=I&&99!==r.ms1_1arrpos&&(I+=E,M[g]=i.swapms(Se))));else if("ms2_4"!=Se.userData.msname){var Ze=d.gcd("ms2y");pe=Ze.t,Ze.y&&(i.ms2y.y=1),q=F,i.ms2y.y&&(Se.children[0].material.color.setRGB(255,255,0),Se.userData.color=x,i.ms2y.y=0,pe>=I&&99!==r.ms2_1arrpos&&(I+=E,M[g]=i.swapms(Se,b)))}T.set(h.position.x,h.position.y,h.position.z),k.set(Se.position.x,Se.position.y,Se.position.z);var $e=k.x-T.x;$e<4e3&&$e>-4e3&&($e=($e+4e3)/8e3*100,q.style.left=$e+"%");var er=k.y-T.y;er<4e3&&er>-4e3&&(er=(er+4e3)/8e3*100,q.style.top=er+"%");var rr=i.getPlayerDir("forward",h.position),nr=i.tvec();nr.subVectors(k,T).normalize(),"ms1"==Ge.name?H=Math.acos(rr.dot(nr)):A=Math.acos(rr.dot(nr));H<.7||A<.7?L.className="divGreen":L.className="divRed"}"meteor"==Ge.name&&i.rotPlanetoid(Ge,Se)}Z>=0&&(P[settingsarr[1]]&&i.addForce(),P[settingsarr[2]]&&i.minusForce(),P[settingsarr[0]]&&i.phaser(),P[settingsarr[0]]||i.phaseroff(),i.updateSightPos()),Z<0&&(i.sight.material.transparent=!0,i.sight.material.opacity=0);for(var g=0;g<D.length;g++){var sr=D[g],ar=M[g];if("drone"==sr.name){if(sr.prevpos.x===sr.body.position.x&&sr.prevpos.y===sr.body.position.y&&sr.prevpos.z===sr.body.position.z&&0!==sr.ld&&10===j&&(sr.rtm=1,G?sr.ld=1:sr.ld=2),0===j&&sr.prevpos.set(sr.body.position.x,sr.body.position.y,sr.body.position.z),sr.ld&&(ar.userData.ld=sr.ld),ar.userData.ld&&(sr.ld=ar.userData.ld),sr.rtm&&(ar.userData.rtm=1,sr.rtm=2),ar.userData.ld)if(G&&2!=sr.ld||!G&&1!=sr.ld){var or=i.updateDrones(sr,ar,sr.ms);or&&(z++,B++),0==ar.userData.ld&&0==ar.userData.rtm&&(sr.rtm=0,sr.ld=0),ar.userData.rtm&&2!=sr.rtm&&(ie.push({id:sr.id+"8888",ld:sr.ld,body:{position:{x:sr.body.position.x,y:sr.body.position.y,z:sr.body.position.z},linearVelocity:{x:0,y:0,z:0}}}),sr.rtm=2),sr.rtm||ar.userData.tbd||ie.push(sr)}else ar.position.copy(sr.getPosition()),ar.lookAt(M[1].position);ar.userData.ld||ar.userData.rtm||(O.sub(h.position,M[g].position),O.length()<4500?G?ar.userData.ld=1:ar.userData.ld=2:(sr.body.linearVelocity.set(0,0,0),sr.body.angularVelocity.set(0,0,0),3!=b&&6!=b||sr.body.position.subEqual(U)))}}if(3!==b)for(var Ke=4;Ke--;)6!=b&&r.ms1phaser.children[Ke]&&(20*r.ms1phaser.children[Ke].scale.z<Q?(r.ms1phaser.children[Ke].scale.z+=.5,r.ms1phaser.children[Ke].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0),r.ms2phaser.children[Ke]&&(20*r.ms2phaser.children[Ke].scale.z<W?(r.ms2phaser.children[Ke].scale.z+=.5,r.ms2phaser.children[Ke].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0);S=P[32]?1:0,setTimeout(d.update(D[0].body.position,D[0].body.linearVelocity,M[0].quaternion,S,ie,i.ms1y,i.ms2y),0)}},threejsrender:function(){i.render(),i.controls.update(),requestAnimationFrame(V.threejsrender)},handlerespawn:function(){if(Z=-200,o(be,xe,b),99===r.ms1_1arrpos&&Z<0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){var e=b+1;document.getElementById("level"+e+"Img").style.display="none"}},planetex:function(){var e=p.create(!0,250);e.name="pex",e.userData.timecreated=x+.001;for(var n=i.scene.children[r.mesharrpos.pl].children,s=0;s<n.length;s++)n[s].name==R&&(n[s].material.visible=!1,e.position.copy(n[s].position));document.getElementById("respawnImg").style.display="block",me.push(e),i.scene.add(e)},populate:function(n){var s,a,o,t,p,m,h;a=0,t=0,o=0,p=m=h=30;var y=[],v=[];X=0,w&&(y=[{type:"sphere",size:[_,_,_],pos:[0,0,0],move:!0,noSleep:!0,world:c,color:16777215,wireframe:"false",name:"shp1",transparent:"true",opacity:0,image:"cpv/cpvLge.obj",mtl:"cpv/cpv.mtl"},{type:"sphere",size:[8,8,8],pos:[0,0,0],move:!0,world:c,color:"#ff0000",wireframe:"false",name:"containerMesh",transparent:"false",opacity:1,image:0}],i.addLine(),i.addPlane("planetGlow")),w||(r.startRender+=1);for(var g=0;J[g];)n[J[g]]&&(n[J[g]].new=0),g++;this.levelobj=n,ce=this.levelobj.numofast,u=this.levelobj.pex_t,E=this.levelobj.dow,I=E;for(s in this.levelobj){if("p"==s.charAt(0)&&"pglowt"!=s&&"pex_t"!=s){if("planet1"==s){$=this.levelobj[s].size[0]/2;var f=this.levelobj[s].pos;i.planetpos.set(f[0],f[1],f[2])}0!==this.levelobj[s]&&y.push(this.levelobj[s])}"m"==s.charAt(0)&&0!==this.levelobj[s]&&v.push(this.levelobj[s]),"drone"==s&&(X=this.levelobj[s],Y=this.levelobj[s])}for(var g=i.scene.children[r.mesharrpos.pl].children.length;g--;)ee.indexOf(i.scene.children[r.mesharrpos.pl].children[g].name)!=-1&&(i.scene.children[r.mesharrpos.pl].children[g].material.visible=!1);for(var g=D.length;g--;)ee.indexOf(D[g].name)!=-1&&(c.removeRigidBody(D[g].body),D.splice(g,1),z-=1);for(var g=0;g<y.length;g++){if("containerMesh"!=y[g].name){if("planet"==y[g].class&&y[g].name.match("1")&&(i.scene.children[r.mesharrpos.planetGlow].position.set(y[g].pos[0],y[g].pos[1],y[g].pos[2]),i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,R=y[g].name),y[g].world=c,D[z]=new e.Body(y[g]),"planet"==y[g].class&&D[z].body.sleep(),ee.indexOf(y[g].name)!=-1){var f=ee.indexOf(y[g].name),x=i.scene.children[r.mesharrpos.pl].children[f];x.material.visible=!0,x.position.set(y[g].pos[0],y[g].pos[1],y[g].pos[2]),"RawShaderMaterial"==x.material.type&&(x.material.uniforms.colvar1.value=Math.random(),x.material.uniforms.colvar2.value=Math.random(),x.material.needsUpdate=!0)}ee.indexOf(y[g].name)==-1&&(i.addSphere(y[g]),"shp1"!=y[g].name&&ee.push(y[g].name)),"shp1"==D[z].name&&(w&&(D[z].r1=35),i.setBodys(D[z])),z+=1}"containerMesh"==y[g].name&&i.addSphere(y[g])}var M=v.length;for(oe=[];M--;)oe.push(v[M].name),J.indexOf(v[M].name)===-1&&J.push(v[M].name);for(var g=0;g<J.length;g++)if(void 0!=v[g]&&v[g].new){i.addBox(v[g]),i.addBox({type:"box",pos:v[g].pos,world:"world",name:v[g].name+"_1",msname:v[g].name+"_1",image:"ms/"+v[g].name+"_1.obj",mtl:"ms/"+v[g].name+".mtl"}),v[g].new=0;var B={type:"cylinder",name:"ms"+(g+1)+"phaser",color:39423};i.addCylinder(B);var j;j="ms1"==v[g].msname?C:F,v[g].pos[0]>0?j.style.left="100%":j.style.left="0"}else for(var q=i.scene.children.length;q--;)if(i.scene.children[q].name.substr(0,3)==J[g])if(i.scene.children[q].userData.msname==J[g]){if(oe.indexOf(i.scene.children[q].userData.msname)!=-1?(i.scene.children[q].children[0].material.transparent=!1,i.scene.children[q].children[0].material.opacity=1,i.scene.children[q].position.set(v[g].pos[0],v[g].pos[1],v[g].pos[2]),i.scene.children[q].name=i.scene.children[q].userData.msname,r.startRender+=1):(i.scene.children[q].children[0].material.transparent=!0,i.scene.children[q].children[0].material.opacity=0,i.scene.children[q].name=i.scene.children[q].userData.msname),"ms1"==i.scene.children[q].userData.msname)var V=r.ms1phaser.children,B=r.ms1phaser;if("ms2"==i.scene.children[q].userData.msname)var V=r.ms2phaser.children,B=r.ms2phaser;for(var S=V.length;S--;){var G=V[S].geometry,P=V[S].material;G.dispose(),P.dispose(),B.remove(V[S])}if(oe.indexOf(i.scene.children[q].userData.msname)!=-1){i.scene.children[q].children[0].remove(B);var O=i.scene.children[q].userData.msname,B={type:"cylinder",name:O+"phaser",color:39423};i.addCylinder(B)}}else i.scene.children[q].children[0].material.transparent=!0,i.scene.children[q].children[0].material.opacity=0,v[g]&&i.scene.children[q].position.set(v[g].pos[0],v[g].pos[1],v[g].pos[2]),i.scene.children[q].name=i.scene.children[q].userData.msname;for(var T=0;T<v.length;T++)v[T].world=c,D[z]=new e.Body(v[T]),D[z].name=v[T].msname,z+=1;for(var k=0,L=[i.planetpos,i.tvec(v[0].pos[0],v[0].pos[1],v[0].pos[2]),i.tvec(0,0,0)],H=[9,7,5,3,2],q=0;q<ce;q++){var A=l.create(H[k]);A.name="astgroup"+q;var a=this.randMinMax(-15e3,15e3),o=this.randMinMax(-15e3,15e3),t=this.randMinMax(-15e3,15e3);A.position.set(a,o,t),i.scene.add(A),D[z]=new e.Body({move:!0,name:"astgroup"+q,noSleep:!0,size:[70,50],pos:[a,o,t],type:"cylinder",world:c,density:1e3}),z++;var N=i.tvec();Math.random();N.subVectors(A.position,L[this.randMinMax(0,2)]).normalize();var U=this.randMinMax(-20,-30);N.multiplyScalar(U),D[z-1].body.linearVelocity.addTime(N,c.timeStep),D[z-1].body.angularVelocity.set(Math.random(),Math.random(),Math.random(),Math.random()),0!==r.asteroids.children.length&&r.asteroids.children.length%10==0&&k++,r.asteroids.add(A)}w&&i.scene.add(r.asteroids),r.raycastarr.push(r.asteroids);var a,o,Q=[],W=0,Z=v.length,re=0,t=0;if(1===b)var se=8;else var se=Math.round(X/(4*Z));if(0!=K){for(var ae=i.scene.children[i.dronenum].children.length-1;ae>X;){var G=i.scene.children[i.dronenum].children[ae].geometry,P=i.scene.children[i.dronenum].children[ae].material;i.scene.children[i.dronenum].remove(i.scene.children[i.dronenum].children[ae]),ae-=1}for(var g=0;g<i.scene.children[i.dronenum].children.length;g++)i.scene.children[i.dronenum].children[g].userData.ld=0;for(var g=D.length-1;g--&&K>X;)"drone"==D[g].name&&(D.splice(g,1),z--,K--);X-=K;for(var g=D.length;g--;)if("drone"==D[g].name){var f=this.dronePos(v[0]);D[g].body.position.set(f[0]/100,f[1]/100,f[2]/100),D[g].ld=0,D[g].nrtm=0,D.push(D.splice(g,1)[0])}}w||X--;for(var g=0;g<=X;g++)if(re<=X/Z){var f=this.dronePos(v[W]),te={type:"cylinder",size:[p,m,h],pos:f,move:!0,world:c,noSleep:!1,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};0==g&&w?te.pos=[1e4,1e4,1e4]:(D[z]=new e.Body(te),D[z].id=0,D[g].rtm=0,D[z].ms=v[W].msname,D[z].tbd=0,D[z].disabled=0,D[z].prevpos=new e.Vec3(D[z].body.position.x,D[z].body.position.y,D[z].body.position.z),se&&(D[z].ld=0,D[z].nrtm=0,se-=1),se||(D[z].ld=0,D[z].nrtm=0),z+=1,re+=1),Q.push(te)}else{W+=1,re=0,se=Math.round(X/(4*Z));var f=this.dronePos(v[W]),te={type:"cylinder",size:[p,m,h],pos:f,move:!0,world:c,noSleep:!1,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};D[z]=new e.Body(te),D[z].id=0,D[z].ms=v[W].msname,D[z].tbd=0,D[z].prevpos=new e.Vec3(D[z].body.position.x,D[z].body.position.y,D[z].body.position.z),z+=1,Q.push(te)}if(w){i.addCylinder(Q);for(var ie=[{type:"cylinder",move:"true",world:c,name:"exdrone1",transparent:"false",opacity:1,image:"ani/exdrone1.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:c,name:"exdrone2",transparent:"false",opacity:1,image:"ani/exdrone2.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:c,name:"exdrone3",transparent:"false",opacity:1,image:"ani/exdrone3.obj",mtl:"images/ani/BaseMaterial_normal.png"}],g=0;g<ie.length;g++)i.addCylinder(ie[g]);X-=1;var de={type:"sphere",move:"true",world:c,name:"dphasers",transparent:"false",opacity:1,image:"phasers/dphaser.obj",texture:"images/phasers/bluefire.png"};i.addSphere(de),i.addPlane("laser")}else{r.startRender+=6;for(var g=0;g<i.scene.children.length;g++)if("drones"==i.scene.children[g].name)for(var q=Q.length;q--;){var le=i.scene.children[g].children[0].clone();le.position.set(Q[q].pos[0],Q[q].pos[1],Q[q].pos[2]),i.scene.children[g].add(le)}}K&&(X+=K),ne=v.length+7,w&&this.render(),d.firstStream=1,d.startgame=2},dronePos:function(e){var r=this.randMinMax(-1e3,1e3),n=this.randMinMax(-1e3,1e3),s=this.randMinMax(-1e3,1e3);return r+=e.pos[0],n+=e.pos[1],s+=e.pos[2],[r,n,s]},loadExdrone:function(e){r.exdrone1.userData.active=!0;var n=r.exdrone1.children[0].clone();n.position.set(e.position.x,e.position.y,e.position.z),n.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),n.visible=!0,r.exdrone1.children.push(n)},expartfunc:function(e){for(var n=i.expart(),s=0;s<n.geometry.vertices.length;s++)n.geometry.vertices[s].x=e.x,n.geometry.vertices[s].y=e.y,n.geometry.vertices[s].z=e.z;n.userData.timecreated=x,r.grouppart.add(n)},getObj:function(e){switch(e){case"bodys":return D;case"containerMesh":return h;case"host":return G;case"shp1r":return _;case"v3d":return i;case"world":return c;case"keys":return P;case"x982y":return b;case"endsequence":return Z}},randMinMax:function(e,r){return Math.floor(Math.random()*(r-e+1))+e},isSleeping:function(e){for(var r=0;r<D.length;r++)if(D[r].name==e)return D[r].getSleep()},gspause:function(e){return void 0==e?t:void(t=e)},removegeomat:function(e){if(0!==e.children.length)for(var r=e.children.length;r--;)this.removegeomat(e.children[r]),e.remove(e.children[r]);else"Mesh"==e.type&&(e.geometry.dispose(),e.material.dispose())},levelGen:function(e){e?b=1:b+=1,d.firstStream=2,d.server_updates=[],d.ms1y={y:0,t:1},d.ms2y={y:0,t:1},d.respawning||d.levelGen(b),d.respawning=0,d.respawn.firepx=0,r.x982y=b;for(var n=0;n<i.scene.children.length;n++)i.scene.children[n].userData.msname&&("ms1_4"==i.scene.children[n].userData.msname?i.scene.children[n].children[0].material.color.setRGB(0,0,0):i.scene.children[n].children[0].material.color.setRGB(.64,.64,.64));3===b||6===b?i.eg.material.visible=!0:i.eg.material.visible=!1,i.scene.children[r.mesharrpos.planetGlow].material.visible=!1,K=0;for(var n=D.length;n--;)"drone"==D[n].name&&(K+=1),("dphaser"==D[n].name||D[n].name.match("ast")||D[n].name.match("ms"))&&(c.removeRigidBody(D[n].body),D.splice(n,1),z-=1);for(this.removegeomat(r.asteroids);null!==c.contacts;)c.removeContact(c.contacts);for(var n=r.dphasers.children.length-1;n>0;){var s=r.dphasers.children[n].material,a=r.dphasers.children[n].geometry;a.dispose(),s.dispose(),r.dphasers.remove(r.dphasers.children[n]),n--}w=0,i.ms1y.y=0,i.ms2y.y=0,se=0,e&&(D[0].r1=35),r.startRender=0,r.raycastarr=[],r.ms1_1arrpos=0,r.ms2_1arrpos=0,z=D.length,M=[],B=0,h=0,te-=10,le=1,pe=1,this.lgd(b),Z=100,e?(document.getElementById("respawnImg").style.display="none",document.getElementById("droneCount").style.display="none",document.getElementById("respawntxt").innerHTML="",i.sight.material.transparent=!1,i.sight.material.opacity=1,te=60):document.getElementById("level"+b+"Img").style.display="none",G?(D[0].body.position.set(0,0,0),D[1].body.position.set(.2,0,-1),D[1].body.sleepPosition.set(.2,0,-1)):(D[0].body.position.set(.2,0,-1),D[1].body.position.set(0,0,0),D[1].body.sleepPosition.set(0,0,0))},lgd:function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==this.readyState&&200==this.status&&V.populate(JSON.parse(this.responseText))},r.open("POST",url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("l="+e)}}}});