define(["three"],function(e){"use strict";var t={};return t.ToRad=Math.PI/180,t.ToDeg=180/Math.PI,t.msePos=new e.Vector3(0,0,0),t.mm=0,t.startRender=0,t.bincam=1,t.exdrone1,t.exdrone2,t.exdrone3,t.phasers,t.dphasers,t.mesharrpos={phasers:0,dphasers:0,pl:0,planetGlow:0,shp1:0,gs:0,ms1:0},t.grouppart=new e.Object3D,t.ms1phaser=new e.Group,t.ms2phaser=new e.Group,t.asteroids=new e.Group,t.stars=new e.Group,t.asteroids.name="asteroids",t.percom=document.getElementById("perCom"),t.ms1_1arrpos=0,t.ms2_1arrpos=0,t.x982y=1,t.raycastarr=[],t.clientx=0,t.clienty=0,t.pageX=window.innerWidth/2,t.pageY=window.innerHeight/2,t.View=function(e,t,s){var i=document.getElementById("container");this.w=i.clientWidth,this.h=i.clientHeight,this.id="container",this.init(e,t,s),this.initBasic(),this.sight,this.startRot=0,this.world,this.ismobile=!1},t.View.prototype={constructor:t.View,init:function(s,i,r){this.clock=new e.Clock,this.renderer=new e.WebGLRenderer({precision:"mediump",antialias:!1}),this.renderer=new e.WebGLRenderer({antialias:!1}),this.renderer.setSize(this.w,this.h),this.renderer.setClearColor(0,1),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.autoClear=!0,this.camera=new e.PerspectiveCamera(60,this.w/this.h,1,5e4),this.camera.useQuarternion=!0,this.tanFOV=Math.tan(Math.PI/180*this.camera.fov/2);document.getElementById("insideship");t.bincam=settingsarr[3],t.bincam?this.camera.position.z=20:this.camera.position.z=.1,this.camera.matrixAutoUpdate=!0,this.scene=new e.Scene,this.scene.background=new e.Color(0),this.camP=new e.PerspectiveCamera(50,this.w/this.h,1,2e4),this.camP.position.set(0,0,30),this.camP.lookAt(new e.Vector3(0,0,0)),this.camHelper=new e.CameraHelper(this.camP),this.container=document.getElementById(this.id),this.renderer.domElement.id="gamecanvas",this.container.appendChild(this.renderer.domElement),this.miniMap=null,this.player=null,this.raycaster=new e.Raycaster,this.matrixWorld=new e.Matrix4,this.matrix2=new e.Matrix4,this.matrix3=new e.Matrix4,this.cpn=new e.Vector3(0,0,0),this.len=0,this.cp=new e.Vector3,this.camdir=new e.Vector3,this.tusv=new e.Vector3,this.q=new e.Quaternion,this.m=new e.Matrix4,this.angle=0,this.containerMesh=0,this.camrot=new e.Vector3,this.pbrot=new e.Vector3,this.tmpvecmse=new e.Vector3,this.newsightpos=new e.Vector3,this.dir=new e.Vector3,this.bodys=[],this.reverse=!1,this.heading=new e.Vector3,this.shootStart=new e.Vector3,this.drota=0,this.ldh=new e.Vector3(0,0,1),this.bincount=0,this.dpcnt=0,this.tmpCM=new e.Vector3,this.tmpVCP=new e.Vector3,this.rotaxis=new e.Vector3,this.rotdir=new e.Vector3,this.rottmpCM=new e.Vector3,this.up=new e.Vector3(0,1,0),this.addforce=!1,this.minusforce=!1,this.f=new e.Vector3,this.u=new e.Vector3,this.s=new e.Vector3,this.dronetex,t.grouppart.name="grouppart",this.scene.add(t.grouppart),this.ms1pos=new e.Vector3(0,0,0),this.ms2pos=new e.Vector3(0,0,0),this.distms=new e.Vector3(0,0,0),this.ms1arrpos=0,this.ms2arrpos=0,this.ms1y={y:0,t:0},this.ms2y={y:0,t:0},this.dronenum,this.laser,this.lraycaster=new e.Raycaster,this.rotplanetq=new e.Quaternion,this.planetpos=new e.Vector3(0,0,0);var a=new e.Object3D;a.name="planets",this.scene.add(a),t.mesharrpos.pl=this.scene.children.length-1,this.mouse=new e.Vector2,this.tmpsightz=0,this.pThrust=0,this.thruster,this.astex,this.starpoint,this.glowmesh,this.controls=new e.TrackballControls(this.camera),this.controls.rotateSpeed=2,this.controls.panSpeed=.8,this.controls.noZoom=!0,this.controls.noPan=!0,this.controls.staticMoving=!1,this.controls.dynamicDampingFactor=.3,this.mseCords={pageX:t.pageX,pageY:t.pageY},this.controls.threemm(this.mseCords),this.tmpangle=0,this.boxworld=new e.Box3(new e.Vector3(-15e3,-15e3,-15e3),new e.Vector3(15e3,15e3,15e3)),this.numStars=100,this.loadOBJ("",this.scene,{image:"planets/star.obj",name:"greenstar",mtl:"planets/star.mtl",pos:[0,0,-10]}),this.gsa=0,this.gsaxis=new e.Vector3(0,0,1),this.distSpheres,this.shp1radius,this.eg,this.udrb=0,this.adddphas=0,this.correctvec=0,this.udq=new e.Quaternion},initLight:function(){var t=new e.DirectionalLight(16777215,1.2);t.position.set(0,-1,0),t.name="dirlight";var s=new e.DirectionalLight(16777215,1.2);s.position.set(0,1,0),s.name="dirlight",this.scene.add(t),this.scene.add(s)},initPoints:function(){for(var s=new e.PlaneGeometry(250,250),i=document.getElementById("starfs").textContent,r=document.getElementById("starvs").textContent,a=new e.ShaderMaterial({vertexShader:r,fragmentShader:i,transparent:!0,side:e.DoubleSide}),n=0;n<this.numStars;n++){var o=s.clone(),h=new e.Mesh(o,a),l=this.randMinMax(-15e3,15e3),c=this.randMinMax(-15e3,15e3),m=this.randMinMax(-15e3,15e3);h.position.set(l,c,m),h.name="star",t.stars.add(h)}this.scene.add(t.stars)},expart:function(){for(var t=500,s=new e.Geometry,i=0;i<t;i++){var r=new e.Vector3;s.vertices.push(r)}var a=new e.Points(s,new e.PointsMaterial({size:2,color:"#ffff00"}));return a.name="points1",a},render:function(){if(0!==this.startRot&&0!=this.containerMesh){var s=new e.Vector2(t.pageX,t.pageY);s.x=e.Math.mapLinear(s.x,0,this.w,-1,1),s.y=e.Math.mapLinear(s.y,0,this.h,-1,1),this.ismobile?s.multiplyScalar(5):s.multiplyScalar(10),this.mseCords.pageX+=s.x,this.mseCords.pageY+=s.y,this.controls.threemm(this.mseCords)}for(var i=this.scene.children[t.mesharrpos.pl].children,r=0;r<i.length;r++)i[r].name.match("mercury1")&&(i[0].material.uniforms.u_time.value=performance.now()/1e3);if(this.scene.children[t.mesharrpos.planetGlow].material.visible&&(this.scene.children[t.mesharrpos.planetGlow].lookAt(this.camera.position),this.scene.children[t.mesharrpos.planetGlow].material.uniforms.glowFloat.value+=performance.now()/1e9),this.eg&&this.eg.material.visible){var a=.6,n=new e.Vector3(0,1,0),o=(new e.Vector3).subVectors(this.eg.position,new e.Vector3(this.containerMesh.position.x,this.containerMesh.position.y,this.eg.position.z)),h=Math.acos(o.dot(n)/Math.sqrt(o.lengthSq()*n.lengthSq()));isNaN(h)&&(h=.01),n.set(0,0,-1);var l=(new e.Vector3).subVectors(this.eg.position,new e.Vector3(this.containerMesh.position.x,this.eg.position.y,this.containerMesh.position.z)),c=Math.acos(l.dot(n)/Math.sqrt(l.lengthSq()*n.lengthSq()));if(this.eg.material.uniforms.glowFloat.value>.5&&(this.eg.material.uniforms.glowFloat.value=0),this.eg.material.uniforms.glowFloat.value+=.1,this.eg.quaternion.copy(this.camera.quaternion),this.eg.material.uniforms.endpoint_roundness.value=a,c>1.57)var m=(c-1.57)/1.57*2.5+.5;else var m=(c-1.57)/-1.57*2.5+.5;if(h>1.57)var d=(h-1.57)/1.57*2.5+.5;else var d=(h-1.57)/-1.57*2.5+.5;m+=d,this.eg.material.uniforms.midpoint_roundness.value=m,this.eg.position.copy(this.scene.children[this.ms1arrpos].position);var p=new e.Matrix4;p.makeRotationFromQuaternion(this.scene.children[this.ms1arrpos].quaternion);var u=new e.Vector3(0,0,1);u.applyMatrix4(p),u.multiplyScalar(-500),this.eg.position.add(u)}for(var w=0;w<this.numStars;w++)t.stars.children[w].lookAt(this.camera.position);if(0!==this.containerMesh)for(var g=1;g<this.scene.children[t.mesharrpos.gs].children.length;g++)this.distSpheres=this.containerMesh.position.distanceTo(this.scene.children[t.mesharrpos.gs].children[g].position),this.scene.children[t.mesharrpos.gs].children[g].userData.timealive>30||this.distSpheres<19?(this.scene.children[t.mesharrpos.gs].children[g].material.dispose(),this.scene.children[t.mesharrpos.gs].children[g].geometry.dispose(),this.scene.children[t.mesharrpos.gs].remove(this.scene.children[t.mesharrpos.gs].children[g]),this.bodys[0].r1+=10):(this.gsa>6.28?this.gsa=0:this.gsa+=.008,this.scene.children[t.mesharrpos.gs].children[g].quaternion.setFromAxisAngle(this.gsaxis,this.gsa),this.scene.children[t.mesharrpos.gs].children[g].userData.timealive+=.01);var y=0;y?(this.containerMesh&&this.camHelper.lookAt(this.containerMesh.position),this.camHelper.update(),this.camHelper.visible=!0,this.renderer.render(this.scene,this.camP)):this.renderer.render(this.scene,this.camera);for(var v=this.camera.getWorldDirection(),r=0;r<t.asteroids.children.length;r++){var f=t.asteroids.children[r],p=new e.Matrix4,x=new e.Quaternion;x.copy(f.quaternion),p.makeRotationFromQuaternion(x.conjugate());var u=new e.Vector3(0,0,1);u.applyMatrix4(p);for(var M=0;M<f.children.length;M++)f.children[M].material.uniforms.camdir.value=v,f.children[M].material.uniforms.camera.value=this.camera.position,f.children[M].material.uniforms.lightdir.value.set(u.x,u.y,u.z)}},initBasic:function(){var t={};t.boxTarget=new e.BoxGeometry(50,50,50),t.containerMesh=new e.SphereGeometry(.1),t.phaser=new e.SphereGeometry(.5,32,32),t.dphaser=new e.SphereGeometry(1,32,32),t.earth1=new e.SphereBufferGeometry(1e3,16,12),t.earth1.applyMatrix((new e.Matrix4).makeRotationX(e.Math.degToRad(23.5))),t.shp1=new e.SphereGeometry(.1),t.sight=new e.BoxGeometry(15,15,.5),t.mercelec1=new e.SphereBufferGeometry(750,16,12),t.mothershipbb1=new e.BoxGeometry(700,300,700,10,10,10),t.mothershipbb2=new e.BoxGeometry(1600,300,300,10,10,10),t.moonice=new e.SphereGeometry(500,16,12),t.molten=new e.SphereGeometry(570,16,12),t.msphaser=new e.CylinderGeometry(5,5,20),t.msphaser.applyMatrix((new e.Matrix4).makeRotationX(e.Math.degToRad(90))),t.msphaser2=new e.CylinderGeometry(5,5,20),t.msphaser2.applyMatrix((new e.Matrix4).makeRotationX(e.Math.degToRad(90))),t.laserglow=new e.PlaneGeometry(.8,1e3),this.geos=t},addBox:function(t){if(t.name.match("ms")){var s="";return void this.loadOBJ(s,this.scene,t)}if(!t.image){var i=new e.MeshBasicMaterial({color:t.color,wireframe:t.wireframe,name:t.name,transparent:t.transparent,opacity:t.opacity});t.wireframe&&(i.wireframe=!0)}var r=new e.Mesh(this.geos[t.name],i,t.name);if(r.position.set(t.pos[0],t.pos[1],t.pos[2]),"mothershipbb1"==r.name){var a=new e.Vector3(0,1,0);r.rotateOnAxis(a,-.55)}this.scene.add(r)},addCylinder:function(s){if(s.length>0){var i=this.loadTGA("images/Free_Droid/Materials/BaseMaterial_normal.tga");return this.dronetex=i,void this.loadOBJ(i,this.scene,s)}if("ms1phaser"==s.name){var r=new e.MeshBasicMaterial({color:s.color}),a=[];a[3]=[275,45,130],a[2]=[228,-54,128],a[1]=[-275,51,130],a[0]=[-228,-52,128];for(var n=0;n<4;){var o=new e.Mesh(this.geos.msphaser,r,s.name);o.position.set(a[n][0],a[n][1],a[n][2]),t.ms1phaser.add(o),n++}return void(t.ms1phaser.name="ms1phaserg")}if("ms2phaser"==s.name){var r=new e.MeshBasicMaterial({color:s.color}),a=[];a[2]=[-110,65,-70],a[0]=[90,62,-45],a[1]=[45,60,550],a[3]=[-70,60,550];for(var n=0;n<4;){var o=new e.Mesh(this.geos.msphaser2,r,s.name);o.position.set(a[n][0],a[n][1],a[n][2]),t.ms2phaser.add(o),n++}return void(t.ms2phaser.name="ms2phaserg")}this.loadOBJ(this.dronetex,this.scene,s)},addSphere:function(s){if("planet"==s.class){var i,r="images/"+s.image,a=(new e.TextureLoader).load(r),n=new e.MeshBasicMaterial({map:a});if("mercury1"==s.name||"electric1"==s.name){var o=document.getElementById("planet1fs").textContent,h=document.getElementById("planet1vs").textContent;i=this.geos.mercelec1,a={type:"t",value:a};var l={type:"f",value:1},c=e.UniformsUtils.merge([e.UniformsLib.lights]);c.textureMerc=a,c.u_time=l,c.colvar1={type:"f",value:.164706},c.colvar2={type:"f",value:.666667};var n=new e.RawShaderMaterial({uniforms:c,vertexShader:h,fragmentShader:o,lights:!0,transparent:!1})}else var n=new e.MeshBasicMaterial({map:a});"moon"!=s.name&&"ice"!=s.name||(i=this.geos.moonice),void 0===i&&(i=this.geos[s.name]);var m=new e.Mesh(i,n,s.name);m.position.set(s.pos[0],s.pos[1],s.pos[2]),this.scene.children[t.mesharrpos.pl].add(m)}if("containerMesh"==s.name){var n=new e.MeshBasicMaterial({color:s.color,wireframe:s.wireframe,name:s.name,transparent:s.transparent,opacity:s.opacity}),m=new e.Mesh(this.geos[s.name],n,s.name);m.position.set(s.pos[0],s.pos[1],s.pos[2]),this.scene.add(m)}if("phasers"==s.name||"dphasers"==s.name){var a=(new e.TextureLoader).load(s.texture);this.loadOBJ(a,this.scene,s)}if("shp1"==s.name&&0!=s.image){var a="";this.loadOBJ(a,this.scene,s)}if("shp1"==s.name&&0===s.image){var n=new e.MeshBasicMaterial({color:s.color,wireframe:s.wireframe,name:s.name,transparent:s.transparent,opacity:s.opacity}),m=new e.Mesh(this.geos[s.name],n,s.name);m.position.set(s.pos[0],s.pos[1],s.pos[2]),t.mesharrpos.shp1=this.scene.children.length,this.scene.add(m)}if("phaser"==s.name){var n=new e.MeshBasicMaterial({color:s.color,wireframe:s.wireframe,name:s.name,transparent:s.transparent,opacity:s.opacity}),m=new e.Mesh(this.geos[s.name],n,s.name);m.position.set(s.pos[0],s.pos[1],s.pos[2]),this.scene.add(m)}},addPlane:function(s){if("laser"==s){var i=document.getElementById("laserfs").textContent,r=document.getElementById("laservs").textContent,a=new e.RawShaderMaterial({uniforms:{u_color1:{value:new e.Vector3(51,173,255)},u_color2:{value:new e.Vector3(0,153,255)}},vertexShader:r,fragmentShader:i,transparent:!0,side:e.DoubleSide});this.geos.laserglow.applyMatrix((new e.Matrix4).makeRotationX(e.Math.degToRad(90))),this.glowmesh=new e.Mesh(this.geos.laserglow,a),this.glowmesh.name="glowmesh"}if("planetGlow"==s){var n=document.getElementById("planetGlowfs").textContent,o=document.getElementById("planetGlowvs").textContent,h=new e.PlaneGeometry(5e3,5e3),l=new e.BufferGeometry;l.fromGeometry(h);var a=new e.RawShaderMaterial({uniforms:{glowFloat:{value:.59}},vertexShader:o,fragmentShader:n,transparent:!0,visible:!1}),c=new e.Mesh(l,a);c.name="planetGlow",t.mesharrpos.planetGlow=this.scene.children.length,this.scene.add(c)}if("engineGlow"==s){var m=document.getElementById("engineGlowfs").textContent,d=document.getElementById("engineGlowvs").textContent,p=new e.PlaneGeometry(500,500);p.applyMatrix((new e.Matrix4).makeRotationZ(e.Math.degToRad(90)));var a=new e.RawShaderMaterial({uniforms:{glowFloat:{value:.1},endpoint_roundness:{value:.6},midpoint_roundness:{value:3}},vertexShader:d,fragmentShader:m,transparent:!0,visible:!1});a.side=e.DoubleSide;var u=new e.Mesh(p,a);return u.name="engineGlow",t.mesharrpos.engineGlow=this.scene.children.length,u}},addLine:function(){var s=new e.LineBasicMaterial({color:6750003}),i=new e.Geometry;i.vertices.push(new e.Vector3(-1,1,0),new e.Vector3(-2,2,0),new e.Vector3(1,1,0),new e.Vector3(2,2,0),new e.Vector3(-1,-1,0),new e.Vector3(-2,-2,0),new e.Vector3(1,-1,0),new e.Vector3(2,-2,0));var r=new e.LineSegments(i,s);if(!t.bincam){if(navigator.userAgent.match(/iPhone/i))var i=new e.CircleGeometry(.4,8);else var i=new e.CircleGeometry(.2,8);var s=new e.MeshBasicMaterial({color:39423}),a=new e.Mesh(i,s);r.add(a)}r.name="sight",this.scene.add(r),this.sight=r,0!=this.tmpsightz&&(this.sight.position.z=this.tmpsightz)},gs_mse_pos:function(e,t){return"get"==e?this.sight.position:(this.sight.position.x=t.x,this.sight.position.y=t.y,this.sight.position.z=t.z,void 0)},getPlayerDir:function(t,s){var i=new e.Vector3;if("forward"==t){var r=this.gs_mse_pos("get");i=i.subVectors(r,s)}else i=i.subVectors(s,this.gs_mse_pos("get"));return i.normalize()},updateSightPos:function(){this.cp.setFromMatrixPosition(this.camera.matrixWorld),this.len=this.cp.length(),this.matrixWorld.copy(this.camera.matrixWorld),this.cpn.x=this.matrixWorld.elements[12],this.cpn.y=this.matrixWorld.elements[13],this.cpn.z=this.matrixWorld.elements[14],this.cpn.normalize(),this.matrixWorld.setPosition(this.cpn),this.matrix2.multiplyMatrices(this.matrixWorld,this.matrix2.getInverse(this.camera.projectionMatrix)),this.tmpvecmse.set(t.msePos.x,t.msePos.y,.5),this.tmpvecmse.applyProjection(this.matrix2),this.dir.copy(this.tmpvecmse.sub(this.cpn).normalize()),this.newsightpos.addVectors(this.camera.position,this.dir.multiplyScalar(100)),this.sight.position.set(this.newsightpos.x,this.newsightpos.y,this.newsightpos.z),this.camdir.subVectors(this.camera.position,this.containerMesh.position).normalize(),this.q.setFromAxisAngle(this.camdir,Math.PI/2),this.sight.up.set(this.q.x,this.q.y,this.q.z),this.sight.quaternion.set(this.camera.quaternion.x,this.camera.quaternion.y,this.camera.quaternion.z,this.camera.quaternion.w),t.mm&&this.scene.children[t.mesharrpos.shp1].up.set(this.q.x,this.q.y,this.q.z),this.scene.children[t.mesharrpos.shp1].quaternion.set(this.camera.quaternion.x,this.camera.quaternion.y,this.camera.quaternion.z,this.camera.quaternion.w),this.scene.children[t.mesharrpos.shp1].lookAt(this.sight.position)},applyRot:function(){},lookAtFunc:function(t,s){var i=new e.Matrix4,r=i.elements;return this.f=t.normalize(),this.u.crossVectors(s,this.f).normalize(),this.s.crossVectors(this.f,this.u).normalize(),r[0]=this.u.x,r[4]=this.s.x,r[8]=this.f.x,r[1]=this.u.y,r[5]=this.s.y,r[9]=this.f.y,r[2]=this.u.z,r[6]=this.s.z,r[10]=this.f.z,i},addForce:function(){this.pThrust||(this.playThruster(),this.pThrust=1);var e=this.bodys[0].body,t=this.getPlayerDir("forward",this.containerMesh.position),s=t.equals(this.heading);if(s||this.heading.set(t.x,t.y,t.z),(this.startRot.rot||!s||e.linearVelocity.length()<15)&&e.linearVelocity.length()<40&&(t.multiplyScalar(25),e.linearVelocity.addTime(t,this.world.timeStep),e.linearVelocity.length()>40))for(var i=-2;e.linearVelocity.length()>40;)t.multiplyScalar(i),e.linearVelocity.addTime(t,this.world.timeStep),i--;s&&e.linearVelocity.length()<40&&(t.multiplyScalar(15),e.linearVelocity.addTime(t,this.world.timeStep));var r=e.linearVelocity.length()/40*100-5;accel.style.width=r+"%",e.linearVelocity.length()<5&&this.reverse&&(this.reverse=!1)},minusForce:function(){this.pThrust||(this.playThruster(),this.pThrust=1);var t=this.bodys[0].body,s=new e.Vector3(t.linearVelocity.x,t.linearVelocity.y,t.linearVelocity.z),i=s.length();if(0==s.x&&0==s.y&&0==s.z||this.reverse){var r=this.getPlayerDir("reverse",this.containerMesh.position);if(i<40&&(r.multiplyScalar(15),t.linearVelocity.addTime(r,this.world.timeStep),this.reverse=!0),t.linearVelocity.length()>40)for(var a=-2;t.linearVelocity.length()>40;)r.multiplyScalar(a),t.linearVelocity.addTime(r,this.world.timeStep),a--}else s=s.normalize(),s=s.multiplyScalar(i-.5),t.linearVelocity.copy(s),i<1&&(this.reverse=!0);var n=t.linearVelocity.length()/40*100-5;accel.style.width=n+"%"},phaseroff:function(){t.bincam?this.glowmesh.material.visible=!1:(this.sight.children[0].material.transparent=!0,this.sight.children[0].material.opacity=0)},phaser:function(){5==this.scene.children[t.mesharrpos.shp1].children.length&&0==this.sight.children.length&&(this.scene.children[t.mesharrpos.shp1].add(this.glowmesh),this.glowmesh.position.z+=500),t.bincam?this.glowmesh.material.visible=!0:(this.sight.children[0].material.transparent=!1,this.sight.children[0].material.opacity=1);var e,s,i,r,a,n;e=s=-1,i=r=0,a=n=0,t.bincam||this.lraycaster.setFromCamera(t.msePos,this.camera),t.bincam&&this.lraycaster.set(this.containerMesh.position,this.getPlayerDir("forward",this.containerMesh.position));for(var o=this.lraycaster.intersectObjects(t.raycastarr,!0),h=0;h<o.length;h++)"ms1"==o[h].object.parent.name&&(i||(e=h,i=o[h].distance),i&&o[h].distance<i&&(e=h,i=o[h].distance)),"DestroyerR_Destroyer_Untitled.000"==o[h].object.name&&(r||(s=h,r=o[h].distance),r&&o[h].distance<r&&(s=h,r=o[h].distance)),o[h].object.name.match("astmesh")&&(0===o[h].object.userData.t?"asteroids"==o[h].object.parent.name?o[h].object.userData.atbd=1:o[h].object.parent.userData.atbd=1:o[h].object.userData.t--);for(var h=0;h<o.length;h++)"drone"==o[h].object.name&&0==o[h].object.userData.tbd&&(e!=-1&&o[e].distance>o[h].distance&&(o[h].object.userData.tbd=1,a=1),s!=-1&&o[s].distance>o[h].distance&&(o[h].object.userData.tbd=1,n=1),e===-1&&s===-1&&(o[h].object.userData.tbd=1)),"ms1"==o[h].object.parent.name&&0==this.ms1y.y&&i<26814&&!a&&(this.ms1y.y=1,this.ms1y.t+=1),"DestroyerR_Destroyer_Untitled.000"==o[h].object.name&&0==this.ms2y.y&&r<26814&&!n&&(this.ms2y.y=1,this.ms2y.t+=1),a=0,n=0},playDroneEx:function(e){if(settingsarr[4]){if(e){var t=masterGain.gain.value;masterGain.gain.value=masterGain.gain.value/2}var s=audiocntxt.createBufferSource();s.buffer=sourceObj.droneExpl.buffer,s.connect(masterGain),s.start(0),e&&(masterGain.gain.value=t)}},playpdown:function(){if(settingsarr[4]){var e=audiocntxt.createBufferSource();e.buffer=sourceObj.pdown.buffer,e.connect(masterGain),e.start(0)}},playThruster:function(){settingsarr[4]&&(this.thruster=audiocntxt.createBufferSource(),this.thruster.buffer=sourceObj.thruster.buffer,this.thruster.connect(masterGain),this.thruster.loop=!0,this.thruster.start(0))},playastex:function(){settingsarr[4]&&(this.astex=audiocntxt.createBufferSource(),this.astex.buffer=sourceObj.astex.buffer,this.astex.connect(masterGain),this.astex.start(0))},updateDrones:function(s,i,r){if(this.udrb=s.body,this.adddphas=0,!i.userData.rtm){this.correctvec=new e.Vector3(this.ldh.x,this.ldh.y,this.ldh.z).normalize(),this.ldh.subVectors(this.containerMesh.position,i.position);var a=Math.round(this.ldh.length());if(this.ldh.normalize(),this.m=this.lookAtFunc(this.ldh,this.up),this.udq.setFromRotationMatrix(this.m),this.udrb.setQuaternion(this.udq),this.angle=2*Math.acos(this.udq.w),0===i.userData.bincount){if(this.drota!=this.angle){var n=this.drota-this.angle;n<0&&(n*=-1);var o=n;n<=.01&&(o*=100),n>.01&&n<=.1&&(o*=100),n>.1&&n<1&&(o*=10),this.correctvec.multiplyScalar(-o),this.udrb.linearVelocity.addTime(this.correctvec,this.world.timeStep),this.drota=this.angle}}else a<=1500&&this.normalizelv(this.udrb,3,this.ldh),a>1500&&a<=4e3&&this.normalizelv(this.udrb,8,this.ldh),a>4e3&&a<=1e4&&this.normalizelv(this.udrb,11,this.ldh),a>1e4&&(this.ldh.multiplyScalar(15),this.udrb.linearVelocity.addTime(this.ldh,this.world.timeStep));var h=30+25*t.x982y;if(i.userData.dpcnt>1e3&t.dphasers.children.length<h){this.shootStart.subVectors(this.containerMesh.position,i.position),this.shootStart.normalize(),this.shootStart.addVectors(this.shootStart,i.position);var l=new e.Matrix4;l.extractRotation(i.matrix);var c=new e.Vector3(0,0,1);c=c.applyProjection(l);var o=2e3;c.x*=o,c.y*=o,c.z*=o;var m=t.dphasers.children[0].clone();m.position.set(this.shootStart.x,this.shootStart.y,this.shootStart.z),m.visible=!0,t.dphasers.add(m);var d={type:"sphere",size:[.3,.3,.3],pos:[this.shootStart.x,this.shootStart.y,this.shootStart.z],move:"true",world:this.world,name:"dphaser"},p=this.addPhaser(d,m);p.body.linearVelocity.addTime(c,this.world.timeStep),i.userData.dpcnt=this.randMinMax(0,1e3),this.adddphas=1}else i.userData.dpcnt+=1;"ms1"==r&&this.distms.subVectors(this.ms1pos,i.position),"ms2"==r&&this.distms.subVectors(this.ms2pos,i.position);var u=this.distms.length();u>12e3&&!s.nrtm&&(i.userData.rtm=1)}if(i.userData.rtm){"ms1"==r&&this.distms.subVectors(this.ms1pos,i.position),"ms2"==r&&this.distms.subVectors(this.ms2pos,i.position);var u=this.distms.length();u>4e3&&this.dronedist(1e3,this.distms,this.udrb),u>2800&&u<=4e3&&this.dronedist(50,this.distms,this.udrb),u>2100&&u<=2800&&this.dronedist(30,this.distms,this.udrb),u>1100&&u<=2100&&this.dronedist(10,this.distms,this.udrb),u<=1100&&(i.userData.rtm=0,i.userData.ld=0)}return i.userData.bincount?i.userData.bincount=0:i.userData.bincount=1,this.adddphas},dronedist:function(e,t,s){1e3==e&&s.linearVelocity.set(0,0,0),t.normalize(),t.x*=e,t.y*=e,t.z*=e,s.linearVelocity.addTime(t,this.world.timeStep)},swapms:function(e){if("ms1"==e.name)var s=this.ms1arrpos,i=t.ms1_1arrpos,r=t.ms1phaser,a="ms1";if("ms2"==e.name)var s=this.ms2arrpos,i=t.ms2_1arrpos,r=t.ms2phaser,a="ms2";this.playpdown(),r.children[0].geometry.dispose(),r.children[0].material.dispose(),r.remove(r.children[0]),t.raycastarr[t.raycastarr.indexOf(this.scene.children[s])]=this.scene.children[i],this.scene.children[s].children[0].material.transparent=!0,this.scene.children[s].children[0].material.opacity=0,this.scene.children[i].children[0].material.transparent=!1,this.scene.children[i].children[0].material.opacity=1,this.scene.children[i].quaternion.copy(this.scene.children[this.ms1arrpos].quaternion),this.scene.children[s].name=this.scene.children[i].name,this.scene.children[i].name=a,this.scene.children[i].position.copy(this.scene.children[s].position),this.scene.children[i].quaternion.copy(this.scene.children[s].quaternion),this.scene.children[i].children[0].add(r),s=i,"ms1"==a&&(this.ms1arrpos=i,this.ms1y.t=0,0==r.children.length&&(t.ms1_1arrpos=99,this.eg.material.visible=!1)),"ms2"==a&&(this.ms2arrpos=i,this.ms2y.t=0,0==r.children.length&&(t.ms2_1arrpos=99));var n=this.scene.children.length,o=1,h=this.scene.children[s].userData.msname.substr(-1);for(h=parseInt(h)+1;n--;)this.scene.children[n].userData.msname==this.scene.children[s].name+"_"+h&&(o=0);if(o)this.scene.children[s].userData.msname.substr(-1)<4&&this.addBox({type:"box",pos:[-5e3,0,-2e3],world:"world",name:this.scene.children[s].name+"_"+h,msname:this.scene.children[s].name+"_"+h,image:"ms/"+this.scene.children[s].name+"_"+h+".obj",mtl:"ms/"+a+".mtl"});else for(var n=0;n<this.scene.children.length;n++)if(this.scene.children[n].name.match(a+"_"+h)){"ms1"==a&&(t.ms1_1arrpos=n),"ms2"==a&&(t.ms2_1arrpos=n);break}return this.scene.children[s]},normalizelv:function(e,t,s){e.linearVelocity.length()>=t+1&&(e.linearVelocity.normalize(e.linearVelocity),e.linearVelocity.multiplyScalar(t)),s.multiplyScalar(t),e.linearVelocity.addTime(s,this.world.timeStep)},getObjHeading:function(e,t){return e.applyQuaternion(t).negate()},onProgress:function(e){if(e.lengthComputable){var s=e.loaded/e.total*100;t.percom.innerHTML="  Current "+Math.round(s,2)+"% downloaded "}},onError:function(e){var t=document.getElementById("errScreen");t.innerHTML="<div id='errdiv'><p>"+e.target.responseURL+"</p><p>"+e.target.statusText+"</p><p>"+e.target.status+"</p></div>",t.style.display="block"},loadTGA:function(s){var i=new e.TGALoader,s=i.load(s,function(e){},t.View.prototype.onProgress,t.View.prototype.onError);return s},loadOBJ:function(s,i,r){if(r[0]||"e"==r.name.charAt(0)||"phasers"==r.name||"dphasers"==r.name||"greenstar"==r.name){if(r[0])var a=r[0].image;else var a=r.image;var n=new e.OBJLoader;n.load("images/"+a,function(a){if(a.traverse(function(t){t instanceof e.Mesh&&("MultiMaterial"==t.material.type&&(t.material.materials[0].map=s),"MeshPhongMaterial"==t.material.type&&(t.material.map=s))}),r[0]&&"drone"==r[0].name){for(var n=0;n<r.length;n++)if(0==n)a.children[0].position.set(1e4,1e4,1e4),a.children[0].name="drone",a.children[0].userData.dpcnt=0,a.children[0].userData.rtm=0,a.children[0].userData.ld=0,a.children[0].userData.tbd=0;else{var o=a.children[0].clone();o.position.set(r[n].pos[0],r[n].pos[1],r[n].pos[2]),o.userData.dpcnt=t.View.prototype.randMinMax(0,1e3),a.add(o)}a.name="drones",i.add(a)}"drones"!=a.name&&(a.name=r.name),"exdrone3"==a.name&&(a.userData.active=!1,t.exdrone3=a,t.exdrone3.children[0].visible=!1,i.add(t.exdrone3)),"exdrone2"==a.name&&(a.userData.active=!1,t.exdrone2=a,t.exdrone2.children[0].visible=!1,i.add(t.exdrone2)),"exdrone1"==a.name&&(a.userData.active=!1,t.exdrone1=a,t.exdrone1.children[0].visible=!1,i.add(t.exdrone1)),"phasers"==a.name&&(t.phasers=a,t.phasers.children[0].visible=!1,t.phasers.children[0].name="phaser",t.mesharrpos.phasers=i.children.length,i.add(t.phasers)),"dphasers"==a.name&&(t.dphasers=a,t.dphasers.children[0].visible=!1,t.dphasers.children[0].name="dphaser",t.mesharrpos.dphasers=i.children.length,i.add(t.dphasers)),"greenstar"==a.name&&(t.mesharrpos.gs=i.children.length,a.children[0].material=new e.MeshPhongMaterial({color:new e.Color(0,1,0),reflectivity:1}),a.children[0].material.side=e.DoubleSide,a.children[0].visible=!0,a.children[0].position.set(1e4,1e4,1e4),i.add(a)),t.startRender+=1},t.View.prototype.onProgress,t.View.prototype.onError)}else{var a=r.image,o=r.mtl,h=new e.MTLLoader;h.load("images/"+o,function(s){s.preload();var n=new e.OBJLoader;n.setMaterials(s),n.load("images/"+a,function(e){e.position.set(r.pos[0],r.pos[1],r.pos[2]),e.name=r.name,"shp1"==e.name&&(t.mesharrpos.shp1=i.children.length),r.msname&&(e.userData.msname=r.msname),e.name.match("_")&&(e.children[0].material.transparent=!0,e.children[0].material.opacity=0,e.name.match("_4")&&e.children[0].material.color.setRGB(0,0,0),99!==t.ms1_1arrpos&&e.name.match("ms1")&&(t.ms1_1arrpos=i.children.length),99!==t.ms2_1arrpos&&e.name.match("ms2")&&(t.ms2_1arrpos=i.children.length),e.name.substr(-1)>=1&&(t.startRender-=1)),i.add(e),t.startRender+=1},t.View.prototype.onProgress,t.View.prototype.onError)})}},msla:function(t){var s=new e.Vector3,i=new e.Vector3(t.position.x,t.position.y,t.position.z);i.multiplyScalar(100),s.subVectors(this.planetpos,i),this.m=this.lookAtFunc(s,new e.Vector3(0,1,0));var r=new e.Quaternion;return r.setFromRotationMatrix(this.m),r},newTexture:function(t){return(new e.TextureLoader).load(t)},rotPlanetoid:function(t,s){this.rotplanetq.setFromAxisAngle(new e.Vector3(0,1,0),.1),s.quaternion.multiply(this.rotplanetq),t.body.setQuaternion(s.quaternion),t.awake()},setBodys:function(e){this.bodys.push(e)},setWorld:function(e){this.world=e},tvec:function(t,s,i){return new e.Vector3(t,s,i)},tquat:function(t,s,i,r){return new e.Quaternion(t,s,i,r)},whcam:function(){var e=this.camera.fov*Math.PI/180,t=2*Math.tan(e/2)*300,s=this.w/this.h,i=t*s;return{h:t,w:i}},randMinMax:function(e,t){return Math.floor(Math.random()*(t-e+1))+e}},t});