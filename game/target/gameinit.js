define(["oimo","v3d","asteroid","planetex","setRespawn"],function(e,r,n,s,a){"use strict";return function(){var o=0,i=new r.View,t=new n;t.initMat();var l=new s;l.initMat();var d,c,m,p,h,v=0,y=2,u=8,g=!1,f=0,x=1,b=1,w=[],M=0,D=[],z=0,B=50;new e.Vec3(0,1,0),i.w/2,i.h/2;h=new e.Vec3(0,0,0);var j,_,S,q,G,R=(document.getElementById("container"),[]),E=new e.Vec3,I=i.tvec(0,0,0),V=i.tvec(0,0,0),P=document.getElementById("mapms1"),O=document.getElementById("mapms2"),F=document.getElementById("gmap"),k=1,C=1,N=i.tvec(0,0,0),T=i.tvec(0,0,0),A=0,Q=0,W=[],H=0,L=0,U=0,J=0,X=0,K=[],Y=0,Z=0,$=0,ee=0,re=[],ne=60,se=1,ae=200,oe=[],ie=[],te=.05,le=-.1,de=i.tvec(0,0,0),ce=0,me=new Date;return{createWorld:function(r){d=new e.World(r,y,u,g),d.worldscale(100),d.gravity=new e.Vec3(0,0,0),i.setWorld(d),M=0,i.addPhaser=function(r,n){return w[w.length]=new e.Body(r),D[D.length]=n,w[w.length-1]},p=0,c=[{id:"temp1",gameid:12345,posx:0,posy:0,posz:0,rotx:0,roty:0,rotz:0}],m=0,j=1,J=100;for(var n=0;n<=400;n++){var s=new e.Vec3;if(n%2){var a=[1,1,1],o=this.randMinMax(0,2);a[o]=-1,s.set(10*Math.random()*a[0],10*Math.random()*a[1],10*Math.random()*a[2])}else s.set(10*Math.random(),10*Math.random(),10*Math.random());ie.push(s)}S=this},render:function(){if(setTimeout(S.render,16),99===r.ms1_1arrpos&&J>0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){J--;var n=x+1;document.getElementById("level"+n+"Img").style.display="block"}if(0==J&&S.levelGen(),J<0&&J++,J==-1&&S.levelGen(1),f+=1e-5,!o&&r.startRender==Z){se&&(S.threejsrender(),se=0);var s=[];if(d.step(),$<ne&&$!=-1?$+=.1:$=0,0!=Y&&(Y.ms1&&3!==x&&w[Y.ms1].body.setupMass(2),Y.ms2&&w[Y.ms2].body.setupMass(2),Y=0,document.getElementById("loadingScreen").style.display="none",b&&(document.getElementById("level1Img").style.display="block",ee++)),ee>0&&ee<100&&ee++,100===ee&&(document.getElementById("level1Img").style.display="none"),5==j?j=0:j+=1,!p){Y={ms1:0,ms2:0};for(var c=i.tvec(),m=0,y=0;y<w.length;y++){for(var u=0;u<i.scene.children.length;u++){if(w[y].name==i.scene.children[u].name){if(D.push(i.scene.children[u]),"ms1"==w[y].name||"ms2"==w[y].name){var g=i.msla(w[y].body);w[y].body.setQuaternion(g),b&&(i.scene.add(i.addPlane("engineGlow")),i.eg=i.scene.children[i.scene.children.length-1]),"ms1"==w[y].name?Y.ms1=y:Y.ms2=y}break}var B=K.indexOf(w[y].name);if("planets"==i.scene.children[u].name&&B!=-1&&D.push(i.scene.children[u].children[B]),"drones"==i.scene.children[u].name&&(i.dronenum=u),"containerMesh"==i.scene.children[u].name)var W=u;"ms1"==i.scene.children[u].name&&(i.ms1arrpos=u),"ms2"==i.scene.children[u].name&&(i.ms2arrpos=u),"ms1_1"==i.scene.children[u].name&&(r.ms1_1arrpos=u),"ms2_1"==i.scene.children[u].name&&re.indexOf("ms2")!=-1&&(r.ms2_1arrpos=u)}w[y].name.match("astgroup")&&(D.push(r.asteroids.children[m]),m++)}i.scene.children[i.ms1arrpos].children[0].add(r.ms1phaser),c.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position),A=c.length(),A-=X,i.ms1pos.set(i.scene.children[i.ms1arrpos].position.x,i.scene.children[i.ms1arrpos].position.y,i.scene.children[i.ms1arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms1arrpos]),i.ms2arrpos&&(i.scene.children[i.ms2arrpos].children[0].add(r.ms2phaser),c.subVectors(i.planetpos,i.scene.children[i.ms2arrpos].position),Q=c.length(),Q-=X,i.ms2pos.set(i.scene.children[i.ms2arrpos].position.x,i.scene.children[i.ms2arrpos].position.y,i.scene.children[i.ms2arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms2arrpos])),r.raycastarr.push(i.scene.children[i.dronenum]);for(var u=0;u<r.asteroids.length;u++)r.asteroids[u];for(var u=1;u<i.scene.children[i.dronenum].children.length;u++)D.push(i.scene.children[i.dronenum].children[u]);i.containerMesh=i.scene.children[W],i.controls.target=i.containerMesh.position,p=i.scene.children[W],z=D.length}if(r.exdrone3.userData.active){for(var u=r.exdrone3.children.length-1;u>0;){for(var L=i.expart(),U=0;U<L.geometry.vertices.length;U++)L.geometry.vertices[U].x=r.exdrone3.children[u].position.x,L.geometry.vertices[U].y=r.exdrone3.children[u].position.y,L.geometry.vertices[U].z=r.exdrone3.children[u].position.z;L.userData.timecreated=f,r.grouppart.add(L),r.exdrone3.children[u].geometry.dispose(),r.exdrone3.children[u].material.materials[0].dispose(),r.exdrone3.children[u].material.materials[1].dispose(),r.exdrone3.remove(r.exdrone3.children[u]),u--}r.exdrone3.userData.active=!1}if(r.exdrone2.userData.active){for(var u=r.exdrone2.children.length-1;u>0;){var ae=r.exdrone3.children[0].clone();ae.position.set(r.exdrone2.children[u].position.x,r.exdrone2.children[u].position.y,r.exdrone2.children[u].position.z),ae.quaternion.set(r.exdrone2.children[u].quaternion.x,r.exdrone2.children[u].quaternion.y,r.exdrone2.children[u].quaternion.z,r.exdrone2.children[u].quaternion.w),ae.visible=!0,r.exdrone3.children.push(ae),r.exdrone3.userData.active=!0,r.exdrone2.children[u].geometry.dispose(),r.exdrone2.children[u].material.materials[0].dispose(),r.exdrone2.children[u].material.materials[1].dispose(),r.exdrone2.remove(r.exdrone2.children[u]),u--}r.exdrone2.userData.active=!1}if(r.exdrone1.userData.active){for(var u=r.exdrone1.children.length-1;u>0;){var ae=r.exdrone2.children[0].clone();ae.position.set(r.exdrone1.children[u].position.x,r.exdrone1.children[u].position.y,r.exdrone1.children[u].position.z),ae.quaternion.set(r.exdrone1.children[u].quaternion.x,r.exdrone1.children[u].quaternion.y,r.exdrone1.children[u].quaternion.z,r.exdrone1.children[u].quaternion.w),ae.visible=!0,r.exdrone2.children.push(ae),r.exdrone2.userData.active=!0,r.exdrone1.children[u].geometry.dispose(),r.exdrone1.children[u].material.materials[0].dispose(),r.exdrone1.children[u].material.materials[1].dispose(),r.exdrone1.remove(r.exdrone1.children[u]),u--}r.exdrone1.userData.active=!1}for(var pe,he,ve="shp1",ye="dphaser",ue=d.contacts;null!==ue;){if(null!=ue.body1&&null!=ue.body2&&(pe=ue.body1.name||" ",he=ue.body2.name||" ",(pe==ve&&he==ye||he==ve&&pe==ye)&&(w[0].r1-=1,0===w[0].r1&&(J=-200,a(me,ce,x),99===r.ms1_1arrpos&&J<0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos))))){var n=x+1;document.getElementById("level"+n+"Img").style.display="none"}ue=ue.next}for(var u=0;u<r.grouppart.children.length;u++)if(f-r.grouppart.children[u].userData.timecreated>8e-4)r.grouppart.children[u].geometry.dispose(),r.grouppart.children[u].material.dispose(),r.grouppart.remove(r.grouppart.children[u]);else{for(var ge=r.grouppart.children[u].geometry.vertices,fe=0;fe<ge.length;fe++)r.grouppart.children[u].geometry.vertices[fe].x+=10*Math.random(),r.grouppart.children[u].geometry.vertices[fe].y+=10*Math.random(),r.grouppart.children[u].geometry.vertices[fe].z+=10*Math.random();r.grouppart.children[u].geometry.verticesNeedUpdate=!0}for(var u=oe.length;u--;)if(f-oe[u].userData.timecreated>8e-4){for(var xe=oe[u].children,be=xe.length;be--;)xe[be].material.dispose,xe[be].geometry.dispose,oe[u].remove(xe[be]);i.scene.remove(oe[u]),oe.splice(u,1)}else for(var xe=oe[u].children,fe=0;fe<xe.length;fe++)xe[fe].position.x+=ie[fe].x,xe[fe].position.y+=ie[fe].y,xe[fe].position.z+=ie[fe].z;for(var we,Me,u=w.length;u--;){if(Me=w[u],we=D[u],i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value>v&&J>0){var De=l.create(!0,250);De.name="pex",De.userData.timecreated=f+.001;for(var ze=i.scene.children[r.mesharrpos.pl].children,u=0;u<ze.length;u++)ze[u].name==G&&(ze[u].material.visible=!1,De.position.copy(ze[u].position));a(me,ce,x),J=-200,oe.push(De),i.scene.add(De)}if(we.name.match("ast")){if(we.userData.atbd){i.playastex();var Be;if(Be="Group"==we.type?t.breakDown(we,Me):0)for(var je=0;je<Be.length;je++){r.asteroids.add(Be[je]),w[M]=new e.Body({move:!0,name:Be[je].name,noSleep:!0,size:[30,30,30],pos:[Be[je].position.x,Be[je].position.y,Be[je].position.z],type:"cylinder",world:d}),M++,D.push(Be[je]),r.raycastarr.push(Be[je]);var _e=Math.random();if(je&&(_e*=-1),w[M-1].body.linearVelocity.set(_e,_e,_e),w[M-1].body.newRotation.set(_e,_e,_e),1===we.children.length){var Se=we.children[0];Se.position.set(we.x,we.y,we.z),i.scene.add(Se),i.scene.remove(we),D[u]=Se,Me.name=we.name,r.asteroids.add(D[u])}}if(0===Be){w.splice(u,1),D.splice(u,1),we.geometry.dispose(),we.material.dispose(),r.asteroids.remove(we);for(var qe=0;qe<r.raycastarr.length;qe++)r.raycastarr[qe].name==we.name&&r.raycastarr.splice(qe,1);M-=1,d.removeRigidBody(Me.body);var De=l.create();De.position.copy(we.position),De.name="pex",De.userData.timecreated=f,i.scene.add(De),oe.push(De);var Ge=i.scene.children[r.mesharrpos.gs].children[0].clone();Ge.position.copy(we.position),Ge.visible=!0,Ge.userData.timealive=0,i.scene.children[r.mesharrpos.gs].add(Ge)}}if(!i.boxworld.containsPoint(we.position)){var Re=Me.body.position;Re.multiplyScalar(-1);for(var Ee=["x","y","z"],Ie=3;Ie--;)(Re[Ee[Ie]]>150||Re[Ee[Ie]]<-150)&&(Re[Ee[Ie]]<0?Re[Ee[Ie]]=-149:Re[Ee[Ie]]=149);we.position.copy(Re).multiplyScalar(100),console.log("outside world")}}if("phaser"!=we.name&&"dphaser"!=we.name||(we.userData.timealive?(f-we.userData.timealive>.006&&"dphaser"==we.name&&s.push(w[u].body.shapes.id),f-we.userData.timealive>615e-6&&"phaser"==we.name&&s.push(w[u].body.shapes.id)):we.userData.timealive=f),we.userData.tbd<0&&(we.userData.tbd+=1),!Me.getSleep()&&(we.position.copy(Me.getPosition()),we.quaternion.copy(Me.getQuaternion()),"shp1"==Me.name)){h.set(p.position.x,p.position.y,p.position.z),p.position.set(we.position.x,we.position.y,we.position.z);var Ve=p.position.x-h.x,Pe=p.position.y-h.y,Oe=p.position.z-h.z;i.camera.position.x+=Ve,i.camera.position.y+=Pe,i.camera.position.z+=Oe}if($>=ne)for(var Fe=1;Fe;)"drone"!=w[Fe].name||w[Fe].ld||w[Fe].nrtm||(w[Fe].ld=1,w[Fe].nrtm=1,Fe=0,$=0),Fe==w.length-1&&(Fe=0,$=-1),Fe>0&&Fe<w.length&&(Fe+=1);if(s.indexOf(Me.body.shapes.id)!=-1||1==we.userData.tbd)if(we.userData.tbd&&(de.subVectors(p.position,we.position),de.x>2e3||de.y>2e3||de.z>2e3?i.playDroneEx(1):i.playDroneEx(0),ce++),Me.ld){var ke={pos:[]};"ms1"==Me.ms&&(ke.pos=[i.ms1pos.x,i.ms1pos.y,i.ms1pos.z]),"ms2"==Me.ms&&(ke.pos=[i.ms2pos.x,i.ms2pos.y,i.ms2pos.z]),S.loadExdrone(we);var Ce=S.dronePos(ke);Me.body.position.set(Ce[0]/100,Ce[1]/100,Ce[2]/100),we.userData.tbd=-2}else{w.splice(u,1),D.splice(u,1);var Ne=we.geometry,Be=we.material;Ne.dispose(),"undefined"==typeof Be.dispose?(S.loadExdrone(we),Be.materials[0].dispose(),Be.materials[1].dispose(),i.scene.children[i.dronenum].remove(we),H--,M--):(Be.dispose(),"phaser"==we.name&&i.scene.children[r.mesharrpos.phasers].remove(we),(we.name="dphaser")&&(i.scene.children[r.mesharrpos.dphasers].remove(we),M--,z--)),d.removeRigidBody(Me.body)}if(f-we.userData.color>5e-4&&f-we.userData.color<.001&&(we.children[0].material.color.setRGB(.64,.64,.64),we.userData.color=0),"ms1"==we.name||"ms2"==we.name){if((3===x||6===x)&&"ms1"==we.name){Me.body.position.x>50&&(te=-.05,le=-.1),Me.body.position.x<-50&&(te=.05,le=-.1),N.copy(Me.body.position),Me.body.position.x+=te,Me.body.position.y=0,Me.body.position.z=(le*Math.pow(Me.body.position.x,2)+50)/2;var g=i.msla(Me.body);Me.body.setQuaternion(g);var U=4,c=i.tvec();for(A=c.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position).length(),A-=X,T.subVectors(N,Me.body.position),i.ms1pos.copy(we.position);U--;)r.ms1phaser.children[U]&&(20*r.ms1phaser.children[U].scale.z<A?(r.ms1phaser.children[U].scale.z+=.5,r.ms1phaser.children[U].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0,20*r.ms1phaser.children[U].scale.z>A&&(r.ms1phaser.children[U].scale.z-=.5,r.ms1phaser.children[U].position.z-=5))}"ms1"==Me.name?"ms1_4"!=we.userData.msname&&(_=P,i.ms1y.y&&(we.children[0].material.color.setRGB(255,255,0),we.userData.color=f,i.ms1y.y=0,i.ms1y.t==q&&99!==r.ms1_1arrpos&&(D[u]=i.swapms(we)))):"ms2_4"!=we.userData.msname&&(_=O,i.ms2y.y&&(we.children[0].material.color.setRGB(255,255,0),we.userData.color=f,i.ms2y.y=0,i.ms2y.t==q&&99!==r.ms2_1arrpos&&(D[u]=i.swapms(we,x)))),I.set(p.position.x,p.position.y,p.position.z),V.set(we.position.x,we.position.y,we.position.z);var Te=V.x-I.x;Te<4e3&&Te>-4e3&&(Te=(Te+4e3)/8e3*100,_.style.left=Te+"%");var Ae=V.y-I.y;Ae<4e3&&Ae>-4e3&&(Ae=(Ae+4e3)/8e3*100,_.style.top=Ae+"%");var Qe=i.getPlayerDir("forward",p.position),We=i.tvec();We.subVectors(V,I).normalize(),"ms1"==Me.name?k=Math.acos(Qe.dot(We)):C=Math.acos(Qe.dot(We));k<.7||C<.7?F.className="divGreen":F.className="divRed"}"meteor"==Me.name&&i.rotPlanetoid(Me,we)}J>=0&&(R[settingsarr[1]]&&i.addForce(),R[settingsarr[2]]&&i.minusForce(),R[settingsarr[0]]&&i.phaser(),R[settingsarr[0]]||i.phaseroff(),i.updateSightPos()),J<0&&(i.sight.material.transparent=!0,i.sight.material.opacity=0);for(var u=0;u<w.length;u++){var He=w[u],Le=D[u];if("drone"==He.name){if(Le.userData.ld||He.ld){He.ld&&(Le.userData.ld=1);var Ue=i.updateDrones(He,Le,He.ms);Ue&&(M++,z++)}Le.userData.ld||Le.userData.rtm||(E.sub(p.position,D[u].position),E.length()<4500?Le.userData.ld=1:(He.body.linearVelocity.set(0,0,0),He.body.angularVelocity.set(0,0,0),3!=x&&6!=x||He.body.position.subEqual(T)))}}if(3!==x)for(var U=4;U--;)6!=x&&r.ms1phaser.children[U]&&(20*r.ms1phaser.children[U].scale.z<A?(r.ms1phaser.children[U].scale.z+=.5,r.ms1phaser.children[U].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0),r.ms2phaser.children[U]&&(20*r.ms2phaser.children[U].scale.z<Q?(r.ms2phaser.children[U].scale.z+=.5,r.ms2phaser.children[U].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0)}},threejsrender:function(){i.render(),i.controls.update(),requestAnimationFrame(S.threejsrender)},populate:function(n){var s,a,o,l,c,m,p;a=0,l=0,o=0,c=m=p=30;var h=[],y=[];H=0,b&&(h=[{type:"sphere",size:[B,B,B],pos:[0,0,0],move:!0,noSleep:!0,world:d,color:16777215,wireframe:"false",name:"shp1",transparent:"true",opacity:0,image:"cpv/cpv.obj",mtl:"cpv/cpv.mtl"},{type:"sphere",size:[8,8,8],pos:[0,0,0],move:!0,world:d,color:"#ff0000",wireframe:"false",name:"containerMesh",transparent:"false",opacity:1,image:0}],r.bincam||(h[0].image=0,h[0].mtl=0),i.addLine(),i.addPlane("planetGlow")),!b&&r.bincam&&(r.startRender+=1);for(var u=0;W[u];)n[W[u]]&&(n[W[u]].new=0),u++;this.levelobj=n,ae=this.levelobj.numofast,v=this.levelobj.pex_t,q=this.levelobj.dow,i.pglowt=this.levelobj.pglowt;for(s in this.levelobj){if("p"==s.charAt(0)&&"pglowt"!=s&&"pex_t"!=s){if("planet1"==s){X=this.levelobj[s].size[0]/2;var g=this.levelobj[s].pos;i.planetpos.set(g[0],g[1],g[2])}0!==this.levelobj[s]&&h.push(this.levelobj[s])}"m"==s.charAt(0)&&0!==this.levelobj[s]&&y.push(this.levelobj[s]),"drone"==s&&(H=this.levelobj[s],U=this.levelobj[s])}for(var u=i.scene.children[r.mesharrpos.pl].children.length;u--;)K.indexOf(i.scene.children[r.mesharrpos.pl].children[u].name)!=-1&&(i.scene.children[r.mesharrpos.pl].children[u].material.visible=!1);for(var u=w.length;u--;)K.indexOf(w[u].name)!=-1&&(d.removeRigidBody(w[u].body),w.splice(u,1),M-=1);for(var u=0;u<h.length;u++){if("containerMesh"!=h[u].name){if("planet"==h[u].class&&h[u].name.match("1")&&(i.scene.children[r.mesharrpos.planetGlow].position.set(h[u].pos[0],h[u].pos[1],h[u].pos[2]),i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,G=h[u].name),h[u].world=d,w[M]=new e.Body(h[u]),K.indexOf(h[u].name)!=-1){var g=K.indexOf(h[u].name),f=i.scene.children[r.mesharrpos.pl].children[g];f.material.visible=!0,f.position.set(h[u].pos[0],h[u].pos[1],h[u].pos[2]),"RawShaderMaterial"==f.material.type&&(f.material.uniforms.colvar1.value=Math.random(),f.material.uniforms.colvar2.value=Math.random(),f.material.needsUpdate=!0)}K.indexOf(h[u].name)==-1&&(i.addSphere(h[u]),"shp1"!=h[u].name&&K.push(h[u].name)),"shp1"==w[M].name&&(b&&(w[M].r1=35),i.setBodys(w[M])),M+=1}"containerMesh"==h[u].name&&i.addSphere(h[u])}var D=y.length;for(re=[];D--;)re.push(y[D].name),W.indexOf(y[D].name)===-1&&W.push(y[D].name);for(var u=0;u<W.length;u++)if(void 0!=y[u]&&y[u].new){i.addBox(y[u]),i.addBox({type:"box",pos:y[u].pos,world:"world",name:y[u].name+"_1",msname:y[u].name+"_1",image:"ms/"+y[u].name+"_1.obj",mtl:"ms/"+y[u].name+".mtl"}),y[u].new=0;var z={type:"cylinder",name:"ms"+(u+1)+"phaser",color:39423};i.addCylinder(z);var j;j="ms1"==y[u].msname?P:O,y[u].pos[0]>0?j.style.left="100%":j.style.left="0"}else for(var _=i.scene.children.length;_--;)if(i.scene.children[_].name.substr(0,3)==W[u])if(i.scene.children[_].userData.msname==W[u]){if(re.indexOf(i.scene.children[_].userData.msname)!=-1?(i.scene.children[_].children[0].material.transparent=!1,i.scene.children[_].children[0].material.opacity=1,i.scene.children[_].position.set(y[u].pos[0],y[u].pos[1],y[u].pos[2]),i.scene.children[_].name=i.scene.children[_].userData.msname,r.startRender+=1):(i.scene.children[_].children[0].material.transparent=!0,i.scene.children[_].children[0].material.opacity=0,i.scene.children[_].name=i.scene.children[_].userData.msname),"ms1"==i.scene.children[_].userData.msname)var S=r.ms1phaser.children,z=r.ms1phaser;if("ms2"==i.scene.children[_].userData.msname)var S=r.ms2phaser.children,z=r.ms2phaser;for(var R=S.length;R--;){var E=S[R].geometry,I=S[R].material;E.dispose(),I.dispose(),z.remove(S[R])}if(re.indexOf(i.scene.children[_].userData.msname)!=-1){i.scene.children[_].children[0].remove(z);var V=i.scene.children[_].userData.msname,z={type:"cylinder",name:V+"phaser",color:39423};i.addCylinder(z)}}else i.scene.children[_].children[0].material.transparent=!0,i.scene.children[_].children[0].material.opacity=0,y[u]&&i.scene.children[_].position.set(y[u].pos[0],y[u].pos[1],y[u].pos[2]),i.scene.children[_].name=i.scene.children[_].userData.msname;for(var F=0;F<y.length;F++)y[F].world=d,y[F].noSleep=!0,w[M]=new e.Body(y[F]),w[M].name=y[F].msname,M+=1;for(var k=0,C=[i.planetpos,i.tvec(y[0].pos[0],y[0].pos[1],y[0].pos[2]),i.tvec(0,0,0)],N=[9,7,5,3,2],_=0;_<ae;_++){var T=t.create(N[k]);T.name="astgroup"+_;var a=this.randMinMax(-15e3,15e3),o=this.randMinMax(-15e3,15e3),l=this.randMinMax(-15e3,15e3);T.position.set(a,o,l),i.scene.add(T),w[M]=new e.Body({move:!0,name:"astgroup"+_,noSleep:!0,size:[70,50],pos:[a,o,l],type:"cylinder",world:d,density:1e3}),M++;var A=i.tvec();Math.random();A.subVectors(T.position,C[this.randMinMax(0,2)]).normalize();var Q=this.randMinMax(-20,-30);A.multiplyScalar(Q),w[M-1].body.linearVelocity.addTime(A,d.timeStep),w[M-1].body.angularVelocity.set(Math.random(),Math.random(),Math.random(),Math.random()),0!==r.asteroids.children.length&&r.asteroids.children.length%10==0&&k++,r.asteroids.add(T)}b&&i.scene.add(r.asteroids),r.raycastarr.push(r.asteroids);var a,o,J=[],Y=0,$=y.length,ee=0,l=0;if(1===x)var ne=8;else var ne=Math.round(H/(4*$));if(0!=L){for(var se=i.scene.children[i.dronenum].children.length-1;se>H;){var E=i.scene.children[i.dronenum].children[se].geometry,I=i.scene.children[i.dronenum].children[se].material;i.scene.children[i.dronenum].remove(i.scene.children[i.dronenum].children[se]),se-=1}for(var u=0;u<i.scene.children[i.dronenum].children.length;u++)i.scene.children[i.dronenum].children[u].userData.ld=0;for(var u=w.length-1;u--&&L>H;)"drone"==w[u].name&&(w.splice(u,1),M--,L--);H-=L;for(var u=w.length;u--;)if("drone"==w[u].name){var g=this.dronePos(y[0]);w[u].body.position.set(g[0]/100,g[1]/100,g[2]/100),ne||(w[u].ld=0,w[u].nrtm=0),w[u].ld&&w[u].nrtm&&0!=ne&&ne--,w.push(w.splice(u,1)[0])}}for(var u=0;u<H;u++)if(ee<H/$){var g=this.dronePos(y[Y]),oe={type:"cylinder",size:[c,m,p],pos:g,move:!0,world:d,noSleep:!0,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};0==u&&b?oe.pos=[1e4,1e4,1e4]:(w[M]=new e.Body(oe),w[M].ms=y[Y].msname,ne&&(w[M].ld=1,w[M].nrtm=1,ne-=1),ne||(w[M].ld=0,w[M].nrtm=0),M+=1,ee+=1),J.push(oe)}else{Y+=1,ee=0,ne=Math.round(H/(4*$));var g=this.dronePos(y[Y]),oe={type:"cylinder",size:[c,m,p],pos:g,move:!0,world:d,noSleep:!0,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};w[M]=new e.Body(oe),w[M].ms=y[Y].msname,M+=1,J.push(oe)}if(b){i.addCylinder(J);for(var ie=[{type:"cylinder",move:"true",world:d,name:"exdrone1",transparent:"false",opacity:1,image:"ani/exdrone1.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:d,name:"exdrone2",transparent:"false",opacity:1,image:"ani/exdrone2.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:d,name:"exdrone3",transparent:"false",opacity:1,image:"ani/exdrone3.obj",mtl:"images/ani/BaseMaterial_normal.png"}],u=0;u<ie.length;u++)i.addCylinder(ie[u]);H-=1;var te={type:"sphere",move:"true",world:d,name:"dphasers",transparent:"false",opacity:1,image:"phasers/dphaser.obj",texture:"images/phasers/bluefire.png"};i.addSphere(te),r.bincam&&i.addPlane("laser")}else{r.startRender+=6;for(var u=0;u<i.scene.children.length;u++)if("drones"==i.scene.children[u].name)for(var _=J.length;_--;){var le=i.scene.children[u].children[0].clone();le.position.set(J[_].pos[0],J[_].pos[1],J[_].pos[2]),i.scene.children[u].add(le)}}L&&(H+=L),Z=y.length+7,r.bincam||(Z-=1),b&&this.render()},dronePos:function(e){var r=this.randMinMax(-1e3,1e3),n=this.randMinMax(-1e3,1e3),s=this.randMinMax(-1e3,1e3);return r+=e.pos[0],n+=e.pos[1],s+=e.pos[2],[r,n,s]},loadExdrone:function(e){r.exdrone1.userData.active=!0;var n=r.exdrone1.children[0].clone();n.position.set(e.position.x,e.position.y,e.position.z),n.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),n.visible=!0,r.exdrone1.children.push(n)},getObj:function(e){switch(e){case"bodys":return w;case"containerMesh":return p;case"shp1r":return B;case"v3d":return i;case"world":return d;case"keys":return R;case"x982y":return x;case"endsequence":return J}},randMinMax:function(e,r){return Math.floor(Math.random()*(r-e+1))+e},isSleeping:function(e){for(var r=0;r<w.length;r++)if(w[r].name==e)return w[r].getSleep()},gspause:function(e){return void 0==e?o:void(o=e)},removegeomat:function(e){if(0!==e.children.length)for(var r=e.children.length;r--;)this.removegeomat(e.children[r]),e.remove(e.children[r]);else"Mesh"==e.type&&(e.geometry.dispose(),e.material.dispose())},levelGen:function(e){e?x=1:x+=1,r.x982y=x;for(var n=0;n<i.scene.children.length;n++)i.scene.children[n].userData.msname&&("ms1_4"==i.scene.children[n].userData.msname?i.scene.children[n].children[0].material.color.setRGB(0,0,0):i.scene.children[n].children[0].material.color.setRGB(.64,.64,.64));3===x||6===x?i.eg.material.visible=!0:i.eg.material.visible=!1,i.scene.children[r.mesharrpos.planetGlow].material.visible=!1,i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,L=0;for(var n=w.length;n--;)"drone"==w[n].name&&(L+=1),("dphaser"==w[n].name||w[n].name.match("ast")||w[n].name.match("ms"))&&(d.removeRigidBody(w[n].body),w.splice(n,1),M-=1);for(this.removegeomat(r.asteroids);null!==d.contacts;)d.removeContact(d.contacts);for(var n=r.dphasers.children.length-1;n>0;){var s=r.dphasers.children[n].material,a=r.dphasers.children[n].geometry;a.dispose(),s.dispose(),r.dphasers.remove(r.dphasers.children[n]),n--}w[0].body.position.set(0,0,0),e&&(w[0].r1=35),b=0,i.ms1y.t=0,i.ms2y.t=0,i.ms1y.y=0,i.ms2y.y=0,$=0,r.startRender=0,r.raycastarr=[],r.ms1_1arrpos=0,r.ms2_1arrpos=0,M=w.length,D=[],z=0,p=0,ne-=10,this.lgd(x),J=100,e?(document.getElementById("respawnImg").style.display="none",document.getElementById("droneCount").style.display="none",i.sight.material.transparent=!1,i.sight.material.opacity=1,ne=60):document.getElementById("level"+x+"Img").style.display="none"},lgd:function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==this.readyState&&200==this.status&&S.populate(JSON.parse(this.responseText))},r.open("POST",url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("l="+e)}}}});