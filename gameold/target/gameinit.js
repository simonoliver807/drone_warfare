define(["oimo","v3d","asteroid","planetex"],function(e,r,n,s){"use strict";return function(){var a=0,o=new r.View,i=new n;i.initMat();var t=new s;t.initMat();var l,d,c,m,p,h=0,y=2,v=8,u=!1,g=0,f=1,x=1,b=[],w=0,M=[],D=0,z=50;new e.Vec3(0,1,0),o.w/2,o.h/2;p=new e.Vec3(0,0,0);var B,j,_,S,q,I=(document.getElementById("container"),[]),G=new e.Vec3,R=o.tvec(0,0,0),E=o.tvec(0,0,0),V=document.getElementById("mapms1"),P=document.getElementById("mapms2"),O=document.getElementById("gmap"),k=1,F=1,C=o.tvec(0,0,0),N=o.tvec(0,0,0),T=0,A=0,Q=[],W=0,H=0,L=0,U=0,J=0,X=[],K=0,Y=0,Z=0,$=0,ee=[],re=60,ne=1,se=200,ae=[],oe=[],ie=.05,te=-.1;return{createWorld:function(r){l=new e.World(r,y,v,u),l.worldscale(100),l.gravity=new e.Vec3(0,0,0),o.setWorld(l),w=0,o.addPhaser=function(r,n){return b[b.length]=new e.Body(r),M[M.length]=n,b[b.length-1]},m=0,d=[{id:"temp1",gameid:12345,posx:0,posy:0,posz:0,rotx:0,roty:0,rotz:0}],c=0,B=1,U=100;for(var n=0;n<=400;n++){var s=new e.Vec3;if(n%2){var a=[1,1,1],i=this.randMinMax(0,2);a[i]=-1,s.set(10*Math.random()*a[0],10*Math.random()*a[1],10*Math.random()*a[2])}else s.set(10*Math.random(),10*Math.random(),10*Math.random());oe.push(s)}_=this},render:function(){if(setTimeout(_.render,16),99===r.ms1_1arrpos&&U>0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){U--;var n=f+1;document.getElementById("level"+n+"Img").style.display="block"}if(0==U&&_.levelGen(),U<0&&U++,U==-1&&_.levelGen(1),g+=1e-5,!a&&r.startRender==Y){ne&&(_.threejsrender(),ne=0);var s=[];if(l.step(),Z<re&&Z!=-1?Z+=.1:Z=0,0!=K&&(K.ms1&&3!==f&&b[K.ms1].body.setupMass(2),K.ms2&&b[K.ms2].body.setupMass(2),K=0,document.getElementById("loadingScreen").style.display="none",x&&(document.getElementById("level1Img").style.display="block",$++)),$>0&&$<100&&$++,100===$&&(document.getElementById("level1Img").style.display="none"),5==B?B=0:B+=1,!m){K={ms1:0,ms2:0};for(var d=o.tvec(),c=0,y=0;y<b.length;y++){for(var v=0;v<o.scene.children.length;v++){if(b[y].name==o.scene.children[v].name){if(M.push(o.scene.children[v]),"ms1"==b[y].name||"ms2"==b[y].name){var u=o.msla(b[y].body);b[y].body.setQuaternion(u),x&&(o.scene.add(o.addPlane("engineGlow")),o.eg=o.scene.children[o.scene.children.length-1]),"ms1"==b[y].name?K.ms1=y:K.ms2=y}break}var z=X.indexOf(b[y].name);if("planets"==o.scene.children[v].name&&z!=-1&&M.push(o.scene.children[v].children[z]),"drones"==o.scene.children[v].name&&(o.dronenum=v),"containerMesh"==o.scene.children[v].name)var Q=v;"ms1"==o.scene.children[v].name&&(o.ms1arrpos=v),"ms2"==o.scene.children[v].name&&(o.ms2arrpos=v),"ms1_1"==o.scene.children[v].name&&(r.ms1_1arrpos=v),"ms2_1"==o.scene.children[v].name&&ee.indexOf("ms2")!=-1&&(r.ms2_1arrpos=v)}b[y].name.match("astgroup")&&(M.push(r.asteroids.children[c]),c++)}o.scene.children[o.ms1arrpos].children[0].add(r.ms1phaser),d.subVectors(o.planetpos,o.scene.children[o.ms1arrpos].position),T=d.length(),T-=J,o.ms1pos.set(o.scene.children[o.ms1arrpos].position.x,o.scene.children[o.ms1arrpos].position.y,o.scene.children[o.ms1arrpos].position.z),r.raycastarr.push(o.scene.children[o.ms1arrpos]),o.ms2arrpos&&(o.scene.children[o.ms2arrpos].children[0].add(r.ms2phaser),d.subVectors(o.planetpos,o.scene.children[o.ms2arrpos].position),A=d.length(),A-=J,o.ms2pos.set(o.scene.children[o.ms2arrpos].position.x,o.scene.children[o.ms2arrpos].position.y,o.scene.children[o.ms2arrpos].position.z),r.raycastarr.push(o.scene.children[o.ms2arrpos])),r.raycastarr.push(o.scene.children[o.dronenum]);for(var v=0;v<r.asteroids.length;v++)r.asteroids[v];for(var v=1;v<o.scene.children[o.dronenum].children.length;v++)M.push(o.scene.children[o.dronenum].children[v]);o.containerMesh=o.scene.children[Q],o.controls.target=o.containerMesh.position,m=o.scene.children[Q],D=M.length}if(r.exdrone3.userData.active){for(var v=r.exdrone3.children.length-1;v>0;){for(var H=o.expart(),L=0;L<H.geometry.vertices.length;L++)H.geometry.vertices[L].x=r.exdrone3.children[v].position.x,H.geometry.vertices[L].y=r.exdrone3.children[v].position.y,H.geometry.vertices[L].z=r.exdrone3.children[v].position.z;H.userData.timecreated=g,r.grouppart.add(H),r.exdrone3.children[v].geometry.dispose(),r.exdrone3.children[v].material.materials[0].dispose(),r.exdrone3.children[v].material.materials[1].dispose(),r.exdrone3.remove(r.exdrone3.children[v]),v--}r.exdrone3.userData.active=!1}if(r.exdrone2.userData.active){for(var v=r.exdrone2.children.length-1;v>0;){var se=r.exdrone3.children[0].clone();se.position.set(r.exdrone2.children[v].position.x,r.exdrone2.children[v].position.y,r.exdrone2.children[v].position.z),se.quaternion.set(r.exdrone2.children[v].quaternion.x,r.exdrone2.children[v].quaternion.y,r.exdrone2.children[v].quaternion.z,r.exdrone2.children[v].quaternion.w),se.visible=!0,r.exdrone3.children.push(se),r.exdrone3.userData.active=!0,r.exdrone2.children[v].geometry.dispose(),r.exdrone2.children[v].material.materials[0].dispose(),r.exdrone2.children[v].material.materials[1].dispose(),r.exdrone2.remove(r.exdrone2.children[v]),v--}r.exdrone2.userData.active=!1}if(r.exdrone1.userData.active){for(var v=r.exdrone1.children.length-1;v>0;){var se=r.exdrone2.children[0].clone();se.position.set(r.exdrone1.children[v].position.x,r.exdrone1.children[v].position.y,r.exdrone1.children[v].position.z),se.quaternion.set(r.exdrone1.children[v].quaternion.x,r.exdrone1.children[v].quaternion.y,r.exdrone1.children[v].quaternion.z,r.exdrone1.children[v].quaternion.w),se.visible=!0,r.exdrone2.children.push(se),r.exdrone2.userData.active=!0,r.exdrone1.children[v].geometry.dispose(),r.exdrone1.children[v].material.materials[0].dispose(),r.exdrone1.children[v].material.materials[1].dispose(),r.exdrone1.remove(r.exdrone1.children[v]),v--}r.exdrone1.userData.active=!1}for(var le,de,ce="shp1",me="dphaser",pe=l.contacts;null!==pe;){if(null!=pe.body1&&null!=pe.body2&&(le=pe.body1.name||" ",de=pe.body2.name||" ",(le==ce&&de==me||de==ce&&le==me)&&(b[0].r1-=1,0===b[0].r1&&(U=-200,document.getElementById("respawnImg").style.display="block",99===r.ms1_1arrpos&&U<0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos))))){var n=f+1;document.getElementById("level"+n+"Img").style.display="none"}pe=pe.next}for(var v=0;v<r.grouppart.children.length;v++)if(g-r.grouppart.children[v].userData.timecreated>8e-4)r.grouppart.children[v].geometry.dispose(),r.grouppart.children[v].material.dispose(),r.grouppart.remove(r.grouppart.children[v]);else{for(var he=r.grouppart.children[v].geometry.vertices,ye=0;ye<he.length;ye++)r.grouppart.children[v].geometry.vertices[ye].x+=10*Math.random(),r.grouppart.children[v].geometry.vertices[ye].y+=10*Math.random(),r.grouppart.children[v].geometry.vertices[ye].z+=10*Math.random();r.grouppart.children[v].geometry.verticesNeedUpdate=!0}for(var v=ae.length;v--;)if(g-ae[v].userData.timecreated>8e-4){for(var ve=ae[v].children,ue=ve.length;ue--;)ve[ue].material.dispose,ve[ue].geometry.dispose,ae[v].remove(ve[ue]);o.scene.remove(ae[v]),ae.splice(v,1)}else for(var ve=ae[v].children,ye=0;ye<ve.length;ye++)ve[ye].position.x+=oe[ye].x,ve[ye].position.y+=oe[ye].y,ve[ye].position.z+=oe[ye].z;for(var ge,fe,v=b.length;v--;){if(fe=b[v],ge=M[v],o.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value>h&&U>0){var xe=t.create(!0,250);xe.name="pex",xe.userData.timecreated=g+.001;for(var be=o.scene.children[r.mesharrpos.pl].children,v=0;v<be.length;v++)be[v].name==q&&(be[v].material.visible=!1,xe.position.copy(be[v].position));document.getElementById("respawnImg").style.display="block",U=-200,ae.push(xe),o.scene.add(xe)}if(ge.name.match("ast")){if(ge.userData.atbd){o.playastex();var we;if(we="Group"==ge.type?i.breakDown(ge,fe):0)for(var Me=0;Me<we.length;Me++){r.asteroids.add(we[Me]),b[w]=new e.Body({move:!0,name:we[Me].name,noSleep:!0,size:[30,30,30],pos:[we[Me].position.x,we[Me].position.y,we[Me].position.z],type:"cylinder",world:l}),w++,M.push(we[Me]),r.raycastarr.push(we[Me]);var De=Math.random();if(Me&&(De*=-1),b[w-1].body.linearVelocity.set(De,De,De),b[w-1].body.newRotation.set(De,De,De),1===ge.children.length){var ze=ge.children[0];ze.position.set(ge.x,ge.y,ge.z),o.scene.add(ze),o.scene.remove(ge),M[v]=ze,fe.name=ge.name,r.asteroids.add(M[v])}}if(0===we){b.splice(v,1),M.splice(v,1),ge.geometry.dispose(),ge.material.dispose(),r.asteroids.remove(ge);for(var Be=0;Be<r.raycastarr.length;Be++)r.raycastarr[Be].name==ge.name&&r.raycastarr.splice(Be,1);w-=1,l.removeRigidBody(fe.body);var xe=t.create();xe.position.copy(ge.position),xe.name="pex",xe.userData.timecreated=g,o.scene.add(xe),ae.push(xe);var je=o.scene.children[r.mesharrpos.gs].children[0].clone();je.position.copy(ge.position),je.visible=!0,je.userData.timealive=0,o.scene.children[r.mesharrpos.gs].add(je)}}if(!o.boxworld.containsPoint(ge.position)){var _e=fe.body.position;_e.multiplyScalar(-1);for(var Se=["x","y","z"],qe=3;qe--;)(_e[Se[qe]]>150||_e[Se[qe]]<-150)&&(_e[Se[qe]]<0?_e[Se[qe]]=-149:_e[Se[qe]]=149);ge.position.copy(_e).multiplyScalar(100),console.log("outside world")}}if("phaser"!=ge.name&&"dphaser"!=ge.name||(ge.userData.timealive?(g-ge.userData.timealive>.006&&"dphaser"==ge.name&&s.push(b[v].body.shapes.id),g-ge.userData.timealive>615e-6&&"phaser"==ge.name&&s.push(b[v].body.shapes.id)):ge.userData.timealive=g),ge.userData.tbd<0&&(ge.userData.tbd+=1),!fe.getSleep()&&(ge.position.copy(fe.getPosition()),ge.quaternion.copy(fe.getQuaternion()),"shp1"==fe.name)){p.set(m.position.x,m.position.y,m.position.z),m.position.set(ge.position.x,ge.position.y,ge.position.z);var Ie=m.position.x-p.x,Ge=m.position.y-p.y,Re=m.position.z-p.z;o.camera.position.x+=Ie,o.camera.position.y+=Ge,o.camera.position.z+=Re}if(Z>=re)for(var Ee=1;Ee;)"drone"!=b[Ee].name||b[Ee].ld||b[Ee].nrtm||(b[Ee].ld=1,b[Ee].nrtm=1,Ee=0,Z=0),Ee==b.length-1&&(Ee=0,Z=-1),Ee>0&&Ee<b.length&&(Ee+=1);if(s.indexOf(fe.body.shapes.id)!=-1||1==ge.userData.tbd)if(ge.userData.tbd&&o.playDroneEx(),fe.ld){var Ve={pos:[]};"ms1"==fe.ms&&(Ve.pos=[o.ms1pos.x,o.ms1pos.y,o.ms1pos.z]),"ms2"==fe.ms&&(Ve.pos=[o.ms2pos.x,o.ms2pos.y,o.ms2pos.z]),_.loadExdrone(ge);var Pe=_.dronePos(Ve);fe.body.position.set(Pe[0]/100,Pe[1]/100,Pe[2]/100),ge.userData.tbd=-2}else{b.splice(v,1),M.splice(v,1);var Oe=ge.geometry,we=ge.material;Oe.dispose(),"undefined"==typeof we.dispose?(_.loadExdrone(ge),we.materials[0].dispose(),we.materials[1].dispose(),o.scene.children[o.dronenum].remove(ge),W--,w--):(we.dispose(),"phaser"==ge.name&&o.scene.children[r.mesharrpos.phasers].remove(ge),(ge.name="dphaser")&&(o.scene.children[r.mesharrpos.dphasers].remove(ge),w--,D--)),l.removeRigidBody(fe.body)}if(g-ge.userData.color>5e-4&&g-ge.userData.color<.001&&(ge.children[0].material.color.setRGB(.64,.64,.64),ge.userData.color=0),"ms1"==ge.name||"ms2"==ge.name){if((3===f||6===f)&&"ms1"==ge.name){fe.body.position.x>50&&(ie=-.05,te=-.1),fe.body.position.x<-50&&(ie=.05,te=-.1),C.copy(fe.body.position),fe.body.position.x+=ie,fe.body.position.y=0,fe.body.position.z=(te*Math.pow(fe.body.position.x,2)+50)/2;var u=o.msla(fe.body);fe.body.setQuaternion(u);var L=4,d=o.tvec();for(T=d.subVectors(o.planetpos,o.scene.children[o.ms1arrpos].position).length(),T-=J,N.subVectors(C,fe.body.position),o.ms1pos.copy(ge.position);L--;)r.ms1phaser.children[L]&&(20*r.ms1phaser.children[L].scale.z<T?(r.ms1phaser.children[L].scale.z+=.5,r.ms1phaser.children[L].position.z+=5):o.scene.children[r.mesharrpos.planetGlow].material.visible=!0,20*r.ms1phaser.children[L].scale.z>T&&(r.ms1phaser.children[L].scale.z-=.5,r.ms1phaser.children[L].position.z-=5))}"ms1"==fe.name?"ms1_4"!=ge.userData.msname&&(j=V,o.ms1y.y&&(ge.children[0].material.color.setRGB(255,255,0),ge.userData.color=g,o.ms1y.y=0,o.ms1y.t==S&&99!==r.ms1_1arrpos&&(M[v]=o.swapms(ge)))):"ms2_4"!=ge.userData.msname&&(j=P,o.ms2y.y&&(ge.children[0].material.color.setRGB(255,255,0),ge.userData.color=g,o.ms2y.y=0,o.ms2y.t==S&&99!==r.ms2_1arrpos&&(M[v]=o.swapms(ge,f)))),R.set(m.position.x,m.position.y,m.position.z),E.set(ge.position.x,ge.position.y,ge.position.z);var ke=E.x-R.x;ke<4e3&&ke>-4e3&&(ke=(ke+4e3)/8e3*100,j.style.left=ke+"%");var Fe=E.y-R.y;Fe<4e3&&Fe>-4e3&&(Fe=(Fe+4e3)/8e3*100,j.style.top=Fe+"%");var Ce=o.getPlayerDir("forward",m.position),Ne=o.tvec();Ne.subVectors(E,R).normalize(),"ms1"==fe.name?k=Math.acos(Ce.dot(Ne)):F=Math.acos(Ce.dot(Ne));k<.7||F<.7?O.className="divGreen":O.className="divRed"}"meteor"==fe.name&&o.rotPlanetoid(fe,ge)}U>=0&&(I[settingsarr[1]]&&o.addForce(),I[settingsarr[2]]&&o.minusForce(),I[settingsarr[0]]&&o.phaser(),I[settingsarr[0]]||o.phaseroff(),o.updateSightPos()),U<0&&(o.sight.material.transparent=!0,o.sight.material.opacity=0);for(var v=0;v<b.length;v++){var Te=b[v],Ae=M[v];if("drone"==Te.name){if(Ae.userData.ld||Te.ld){Te.ld&&(Ae.userData.ld=1);var Qe=o.updateDrones(Te,Ae,Te.ms);Qe&&(w++,D++)}Ae.userData.ld||Ae.userData.rtm||(G.sub(m.position,M[v].position),G.length()<4500?Ae.userData.ld=1:(Te.body.linearVelocity.set(0,0,0),Te.body.angularVelocity.set(0,0,0),3!=f&&6!=f||Te.body.position.subEqual(N)))}}if(3!==f)for(var L=4;L--;)6!=f&&r.ms1phaser.children[L]&&(20*r.ms1phaser.children[L].scale.z<T?(r.ms1phaser.children[L].scale.z+=.5,r.ms1phaser.children[L].position.z+=5):o.scene.children[r.mesharrpos.planetGlow].material.visible=!0),r.ms2phaser.children[L]&&(20*r.ms2phaser.children[L].scale.z<A?(r.ms2phaser.children[L].scale.z+=.5,r.ms2phaser.children[L].position.z+=5):o.scene.children[r.mesharrpos.planetGlow].material.visible=!0)}},threejsrender:function(){o.render(),o.controls.update(),requestAnimationFrame(_.threejsrender)},populate:function(n){var s,a,t,d,c,m,p;a=0,d=0,t=0,c=m=p=30;var y=[],v=[];W=0,x&&(y=[{type:"sphere",size:[z,z,z],pos:[0,0,0],move:!0,noSleep:!0,world:l,color:16777215,wireframe:"false",name:"shp1",transparent:"true",opacity:0,image:"cpv/cpv.obj",mtl:"cpv/cpv.mtl"},{type:"sphere",size:[8,8,8],pos:[0,0,0],move:!0,world:l,color:"#ff0000",wireframe:"false",name:"containerMesh",transparent:"false",opacity:1,image:0}],r.bincam||(y[0].image=0,y[0].mtl=0),o.addLine(),o.addPlane("planetGlow")),!x&&r.bincam&&(r.startRender+=1);for(var u=0;Q[u];)n[Q[u]]&&(n[Q[u]].new=0),u++;this.levelobj=n,se=this.levelobj.numofast,h=this.levelobj.pex_t,S=this.levelobj.dow,o.pglowt=this.levelobj.pglowt;for(s in this.levelobj){if("p"==s.charAt(0)&&"pglowt"!=s&&"pex_t"!=s){if("planet1"==s){J=this.levelobj[s].size[0]/2;var g=this.levelobj[s].pos;o.planetpos.set(g[0],g[1],g[2])}0!==this.levelobj[s]&&y.push(this.levelobj[s])}"m"==s.charAt(0)&&0!==this.levelobj[s]&&v.push(this.levelobj[s]),"drone"==s&&(W=this.levelobj[s],L=this.levelobj[s])}for(var u=o.scene.children[r.mesharrpos.pl].children.length;u--;)X.indexOf(o.scene.children[r.mesharrpos.pl].children[u].name)!=-1&&(o.scene.children[r.mesharrpos.pl].children[u].material.visible=!1);for(var u=b.length;u--;)X.indexOf(b[u].name)!=-1&&(l.removeRigidBody(b[u].body),b.splice(u,1),w-=1);for(var u=0;u<y.length;u++){if("containerMesh"!=y[u].name){if("planet"==y[u].class&&y[u].name.match("1")&&(o.scene.children[r.mesharrpos.planetGlow].position.set(y[u].pos[0],y[u].pos[1],y[u].pos[2]),o.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,q=y[u].name),y[u].world=l,b[w]=new e.Body(y[u]),X.indexOf(y[u].name)!=-1){var g=X.indexOf(y[u].name),M=o.scene.children[r.mesharrpos.pl].children[g];M.material.visible=!0,M.position.set(y[u].pos[0],y[u].pos[1],y[u].pos[2]),"RawShaderMaterial"==M.material.type&&(M.material.uniforms.colvar1.value=Math.random(),M.material.uniforms.colvar2.value=Math.random(),M.material.needsUpdate=!0)}X.indexOf(y[u].name)==-1&&(o.addSphere(y[u]),"shp1"!=y[u].name&&X.push(y[u].name)),"shp1"==b[w].name&&(x&&(b[w].r1=1500),o.setBodys(b[w])),w+=1}"containerMesh"==y[u].name&&o.addSphere(y[u])}var D=v.length;for(ee=[];D--;)ee.push(v[D].name),Q.indexOf(v[D].name)===-1&&Q.push(v[D].name);for(var u=0;u<Q.length;u++)if(void 0!=v[u]&&v[u].new){o.addBox(v[u]),o.addBox({type:"box",pos:v[u].pos,world:"world",name:v[u].name+"_1",msname:v[u].name+"_1",image:"ms/"+v[u].name+"_1.obj",mtl:"ms/"+v[u].name+".mtl"}),v[u].new=0;var B={type:"cylinder",name:"ms"+(u+1)+"phaser",color:39423};o.addCylinder(B);var j;j="ms1"==v[u].msname?V:P,v[u].pos[0]>0?j.style.left="100%":j.style.left="0"}else for(var _=o.scene.children.length;_--;)if(o.scene.children[_].name.substr(0,3)==Q[u])if(o.scene.children[_].userData.msname==Q[u]){if(ee.indexOf(o.scene.children[_].userData.msname)!=-1?(o.scene.children[_].children[0].material.transparent=!1,o.scene.children[_].children[0].material.opacity=1,o.scene.children[_].position.set(v[u].pos[0],v[u].pos[1],v[u].pos[2]),o.scene.children[_].name=o.scene.children[_].userData.msname,r.startRender+=1):(o.scene.children[_].children[0].material.transparent=!0,o.scene.children[_].children[0].material.opacity=0,o.scene.children[_].name=o.scene.children[_].userData.msname),"ms1"==o.scene.children[_].userData.msname)var I=r.ms1phaser.children,B=r.ms1phaser;if("ms2"==o.scene.children[_].userData.msname)var I=r.ms2phaser.children,B=r.ms2phaser;for(var G=I.length;G--;){var R=I[G].geometry,E=I[G].material;R.dispose(),E.dispose(),B.remove(I[G])}if(ee.indexOf(o.scene.children[_].userData.msname)!=-1){o.scene.children[_].children[0].remove(B);var O=o.scene.children[_].userData.msname,B={type:"cylinder",name:O+"phaser",color:39423};o.addCylinder(B)}}else o.scene.children[_].children[0].material.transparent=!0,o.scene.children[_].children[0].material.opacity=0,v[u]&&o.scene.children[_].position.set(v[u].pos[0],v[u].pos[1],v[u].pos[2]),o.scene.children[_].name=o.scene.children[_].userData.msname;for(var k=0;k<v.length;k++)v[k].world=l,v[k].noSleep=!0,b[w]=new e.Body(v[k]),b[w].name=v[k].msname,w+=1;for(var F=0,C=[o.planetpos,o.tvec(v[0].pos[0],v[0].pos[1],v[0].pos[2]),o.tvec(0,0,0)],N=[9,7,5,3,2],_=0;_<se;_++){var T=i.create(N[F]);T.name="astgroup"+_;var a=this.randMinMax(-15e3,15e3),t=this.randMinMax(-15e3,15e3),d=this.randMinMax(-15e3,15e3);T.position.set(a,t,d),o.scene.add(T),b[w]=new e.Body({move:!0,name:"astgroup"+_,noSleep:!0,size:[70,50],pos:[a,t,d],type:"cylinder",world:l,density:1e3}),w++;var A=o.tvec();Math.random();A.subVectors(T.position,C[this.randMinMax(0,2)]).normalize();var U=this.randMinMax(-20,-30);A.multiplyScalar(U),b[w-1].body.linearVelocity.addTime(A,l.timeStep),b[w-1].body.angularVelocity.set(Math.random(),Math.random(),Math.random(),Math.random()),0!==r.asteroids.children.length&&r.asteroids.children.length%10==0&&F++,r.asteroids.add(T)}x&&o.scene.add(r.asteroids),r.raycastarr.push(r.asteroids);var a,t,K=[],Z=0,$=v.length,re=0,d=0;if(1===f)var ne=8;else var ne=Math.round(W/(4*$));if(0!=H){for(var ae=o.scene.children[o.dronenum].children.length-1;ae>W;){var R=o.scene.children[o.dronenum].children[ae].geometry,E=o.scene.children[o.dronenum].children[ae].material;o.scene.children[o.dronenum].remove(o.scene.children[o.dronenum].children[ae]),ae-=1}for(var u=0;u<o.scene.children[o.dronenum].children.length;u++)o.scene.children[o.dronenum].children[u].userData.ld=0;for(var u=b.length-1;u--&&H>W;)"drone"==b[u].name&&(b.splice(u,1),w--,H--);W-=H;for(var u=b.length;u--;)if("drone"==b[u].name){var g=this.dronePos(v[0]);b[u].body.position.set(g[0]/100,g[1]/100,g[2]/100),ne||(b[u].ld=0,b[u].nrtm=0),b[u].ld&&b[u].nrtm&&0!=ne&&ne--,b.push(b.splice(u,1)[0])}}for(var u=0;u<W;u++)if(re<W/$){var g=this.dronePos(v[Z]),oe={type:"cylinder",size:[c,m,p],pos:g,move:!0,world:l,noSleep:!0,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};0==u&&x?oe.pos=[1e4,1e4,1e4]:(b[w]=new e.Body(oe),b[w].ms=v[Z].msname,ne&&(b[w].ld=1,b[w].nrtm=1,ne-=1),ne||(b[w].ld=0,b[w].nrtm=0),w+=1,re+=1),K.push(oe)}else{Z+=1,re=0,ne=Math.round(W/(4*$));var g=this.dronePos(v[Z]),oe={type:"cylinder",size:[c,m,p],pos:g,move:!0,world:l,noSleep:!0,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};b[w]=new e.Body(oe),b[w].ms=v[Z].msname,w+=1,K.push(oe)}if(x){o.addCylinder(K);for(var ie=[{type:"cylinder",move:"true",world:l,name:"exdrone1",transparent:"false",opacity:1,image:"ani/exdrone1.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:l,name:"exdrone2",transparent:"false",opacity:1,image:"ani/exdrone2.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:l,name:"exdrone3",transparent:"false",opacity:1,image:"ani/exdrone3.obj",mtl:"images/ani/BaseMaterial_normal.png"}],u=0;u<ie.length;u++)o.addCylinder(ie[u]);W-=1;var te={type:"sphere",move:"true",world:l,name:"dphasers",transparent:"false",opacity:1,image:"phasers/dphaser.obj",texture:"images/phasers/bluefire.png"};o.addSphere(te),r.bincam&&o.addPlane("laser")}else{r.startRender+=6;for(var u=0;u<o.scene.children.length;u++)if("drones"==o.scene.children[u].name)for(var _=K.length;_--;){var le=o.scene.children[u].children[0].clone();le.position.set(K[_].pos[0],K[_].pos[1],K[_].pos[2]),o.scene.children[u].add(le)}}H&&(W+=H),Y=v.length+7,r.bincam||(Y-=1),x&&this.render()},dronePos:function(e){var r=this.randMinMax(-1e3,1e3),n=this.randMinMax(-1e3,1e3),s=this.randMinMax(-1e3,1e3);return r+=e.pos[0],n+=e.pos[1],s+=e.pos[2],[r,n,s]},loadExdrone:function(e){r.exdrone1.userData.active=!0;var n=r.exdrone1.children[0].clone();n.position.set(e.position.x,e.position.y,e.position.z),n.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),n.visible=!0,r.exdrone1.children.push(n)},getObj:function(e){switch(e){case"bodys":return b;case"containerMesh":return m;case"shp1r":return z;case"v3d":return o;case"world":return l;case"keys":return I;case"x982y":return f;case"endsequence":return U}},randMinMax:function(e,r){return Math.floor(Math.random()*(r-e+1))+e},isSleeping:function(e){for(var r=0;r<b.length;r++)if(b[r].name==e)return b[r].getSleep()},gspause:function(e){return void 0==e?a:void(a=e)},removegeomat:function(e){if(0!==e.children.length)for(var r=e.children.length;r--;)this.removegeomat(e.children[r]),e.remove(e.children[r]);else"Mesh"==e.type&&(e.geometry.dispose(),e.material.dispose())},levelGen:function(e){e?f=1:f+=1,r.x982y=f;for(var n=0;n<o.scene.children.length;n++)o.scene.children[n].userData.msname&&("ms1_4"==o.scene.children[n].userData.msname?o.scene.children[n].children[0].material.color.setRGB(0,0,0):o.scene.children[n].children[0].material.color.setRGB(.64,.64,.64));3===f||6===f?o.eg.material.visible=!0:o.eg.material.visible=!1,o.scene.children[r.mesharrpos.planetGlow].material.visible=!1,o.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,H=0;for(var n=b.length;n--;)"drone"==b[n].name&&(H+=1),("dphaser"==b[n].name||b[n].name.match("ast")||b[n].name.match("ms"))&&(l.removeRigidBody(b[n].body),b.splice(n,1),w-=1);for(this.removegeomat(r.asteroids);null!==l.contacts;)l.removeContact(l.contacts);for(var n=r.dphasers.children.length-1;n>0;){var s=r.dphasers.children[n].material,a=r.dphasers.children[n].geometry;a.dispose(),s.dispose(),r.dphasers.remove(r.dphasers.children[n]),n--}b[0].body.position.set(0,0,0),e&&(b[0].r1=1500),x=0,o.ms1y.t=0,o.ms2y.t=0,o.ms1y.y=0,o.ms2y.y=0,Z=0,r.startRender=0,r.raycastarr=[],r.ms1_1arrpos=0,r.ms2_1arrpos=0,w=b.length,M=[],D=0,m=0,re-=10,this.lgd(f),U=100,e?(document.getElementById("respawnImg").style.display="none",o.sight.material.transparent=!1,o.sight.material.opacity=1,re=60):document.getElementById("level"+f+"Img").style.display="none"},lgd:function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==this.readyState&&200==this.status&&_.populate(JSON.parse(this.responseText))},r.open("POST",url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("l="+e)}}}});