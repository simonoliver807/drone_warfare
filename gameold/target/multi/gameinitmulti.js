define(["oimo","v3d","multi/gamecore","asteroid","planetex"],function(e,r,n,s,a){"use strict";return function(){var o=0,i=new r.View,t=new n,d=new s;d.initMat();var l=new a;l.initMat();var p,c,m,h,y=0,u=2,v=8,g=!1,f=0,b=1,x=1,w=[],D=0,z=[],M=0,B=5;new e.Vec3(0,1,0),i.w/2,i.h/2;h=new e.Vec3(0,0,0);var _,j,q,I,V,E,S,G,P=(document.getElementById("container"),[]),R=new e.Vec3,O=i.tvec(0,0,0),k=i.tvec(0,0,0),T=document.getElementById("mapms1"),F=document.getElementById("mapms2"),L=document.getElementById("gmap"),C=1,H=1,A=i.tvec(0,0,0),N=i.tvec(0,0,0),U=0,Q=0,W=[],J=0,X=0,K=0,Y=0,Z=0,$=[],ee=1,re=0,ne=0,se=0,ae=[],oe=60,ie=[],te=1,de=0,le=0,pe=0,ce=[],me=[],he=.05,ye=-.1,ue=i.tvec(0,0,0),ve={pos:[]},ge=0;return{createWorld:function(r){p=new e.World(r,u,v,g),p.worldscale(100),p.gravity=new e.Vec3(0,0,0),i.setWorld(p),t.start(),D=0,i.addPhaser=function(r,n){return w[w.length]=new e.Body(r),z[z.length]=n,w[w.length-1]},m=0,c=0,_=1,Y=100,q=this;for(var n=0;n<400;n++){var s=new e.Vec3;if(n%2){var a=[1,1,1],o=this.randMinMax(0,2);a[o]=-1,s.set(10*Math.random()*a[0],10*Math.random()*a[1],10*Math.random()*a[2])}else s.set(10*Math.random(),10*Math.random(),10*Math.random());me.push(s)}},render:function(){if(setTimeout(q.render,16),99===r.ms1_1arrpos&&Y>0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){Y--;var n=b+1;t.startgame=0,document.getElementById("level"+n+"Img").style.display="block"}if(0==Y&&q.levelGen(0),Y<0&&Y++,Y==-1&&(q.levelGen(1),t.startgame=0),f+=1e-5,!o&&r.startRender==re&&t.startgame){if(t.respawn.restart&&w[0].r1>0){t.respawn.restart=0;var s;t.respawn.firepx?(s="planetary devastation",q.planetex()):s=S?"player 2 is toast":"player 1 is toast",document.getElementById("respawntxt").innerHTML=s,w[0].r1=0,q.handlerespawn(),t.respawning=1}2===t.startgame&&(S=t.gcd("host"),S&&(document.getElementById("respawntxt").innerHTML="delay for player 2"),t.startgame=0),te&&(q.threejsrender(),te=0);var a=[];if(ie=[],p.step(),ne<oe&&ne!=-1?ne+=.1:ne=0,0!=ee&&(ee.ms1&&3!==b&&w[ee.ms1].body.setupMass(2),ee.ms2&&w[ee.ms2].body.setupMass(2),ee=0,document.getElementById("loadingScreen").style.display="none",x&&(document.getElementById("level1Img").style.display="block",se++)),se>0&&se<100&&se++,100===se&&(document.getElementById("level1Img").style.display="none",document.getElementById("respawntxt").innerHTML=""),10==_?_=0:_+=1,!m){ee={ms1:0,ms2:0};for(var c=i.tvec(),u=0,v=0;v<w.length;v++){for(var g=0;g<i.scene.children.length;g++){if(w[v].name==i.scene.children[g].name&&"player2"!=w[v].name){if(z.push(i.scene.children[g]),"shp1"==w[v].name&&x){var B=new e.Body({type:"sphere",size:[5,5,5],pos:[20,0,-100],move:!1,world:p,color:16777215,wireframe:"false",name:"player2",transparent:"true",opacity:0});B.body.sleep(),w.splice(v+1,0,B),D+=1;for(var G=i.scene.children[g].clone(),W=i.scene.children[g].children.length;W--;)if("material_1"==i.scene.children[g].children[W].material.name)var X=W;G.children[X].material=i.scene.children[g].children[X].material.clone();var K=i.glowmesh.clone();G.position.set(20,0,-100),G.name="player2",G.add(K),K.position.z+=500,K.material=i.glowmesh.material.clone(),K.name="pl2glowmesh",i.scene.add(G),z.push(G),z[z.length-1].userData.tquat=i.tquat(),z[z.length-1].userData.pquat=i.tquat();var pe=i.newTexture("images/cpv/ed1apl2.gif");r.bincam||(i.scene.children[g].visible=!1);for(var W=i.scene.children[g].children.length;W--;)if("material_1"==i.scene.children[g].children[W].material.name)var X=W;S?(G.children[X].material.map=pe,G.children[X].material.needsUpdate=!0):(w[0].body.position.set(.2,0,-1),z[0].position.set(20,0,-100),w[1].body.position.set(0,0,0),w[1].body.sleepPosition.set(0,0,0),z[1].position.set(0,0,0),i.scene.children[g].children[X].material.map=pe,i.scene.children[g].children[X].material.needsUpdate=!0)}if("ms1"==w[v].name||"ms2"==w[v].name){var fe=i.msla(w[v].body);w[v].body.setQuaternion(fe),x&&(i.scene.add(i.addPlane("engineGlow")),i.eg=i.scene.children[i.scene.children.length-1]),"ms1"==w[v].name?ee.ms1=v:ee.ms2=v}break}w[v].name!=i.scene.children[g].name||"player2"!=w[v].name||x||z.push(i.scene.children[g]);var be=$.indexOf(w[v].name);if("planets"==i.scene.children[g].name&&be!=-1&&z.push(i.scene.children[g].children[be]),"drones"==i.scene.children[g].name&&(i.dronenum=g),"containerMesh"==i.scene.children[g].name)var xe=g;"ms1"==i.scene.children[g].name&&(i.ms1arrpos=g),"ms2"==i.scene.children[g].name&&(i.ms2arrpos=g),"ms1_1"==i.scene.children[g].name&&(r.ms1_1arrpos=g),"ms2_1"==i.scene.children[g].name&&ae.indexOf("ms2")!=-1&&(r.ms2_1arrpos=g)}w[v].name.match("astgroup")&&(z.push(r.asteroids.children[u]),u++)}i.scene.children[i.ms1arrpos].children[0].add(r.ms1phaser),c.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position),U=c.length(),U-=Z,i.ms1pos.set(i.scene.children[i.ms1arrpos].position.x,i.scene.children[i.ms1arrpos].position.y,i.scene.children[i.ms1arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms1arrpos]),i.ms2arrpos&&(i.scene.children[i.ms2arrpos].children[0].add(r.ms2phaser),c.subVectors(i.planetpos,i.scene.children[i.ms2arrpos].position),Q=c.length(),Q-=Z,i.ms2pos.set(i.scene.children[i.ms2arrpos].position.x,i.scene.children[i.ms2arrpos].position.y,i.scene.children[i.ms2arrpos].position.z),r.raycastarr.push(i.scene.children[i.ms2arrpos])),r.raycastarr.push(i.scene.children[i.dronenum]);for(var g=0;g<r.asteroids.length;g++)r.asteroids[g];for(var g=1;g<i.scene.children[i.dronenum].children.length;g++)z.push(i.scene.children[i.dronenum].children[g]);i.containerMesh=i.scene.children[xe],i.controls.target=i.containerMesh.position,m=i.scene.children[xe],M=z.length,x&&t.setply1ply2(w[0],w[1],z[1],w)}if(r.exdrone3.userData.active){for(var g=r.exdrone3.children.length-1;g>0;)q.expartfunc(r.exdrone3.children[g].position),r.exdrone3.children[g].geometry.dispose(),r.exdrone3.children[g].material.materials[0].dispose(),r.exdrone3.children[g].material.materials[1].dispose(),r.exdrone3.remove(r.exdrone3.children[g]),g--;r.exdrone3.userData.active=!1}if(r.exdrone2.userData.active){for(var g=r.exdrone2.children.length-1;g>0;){var we=r.exdrone3.children[0].clone();we.position.set(r.exdrone2.children[g].position.x,r.exdrone2.children[g].position.y,r.exdrone2.children[g].position.z),we.quaternion.set(r.exdrone2.children[g].quaternion.x,r.exdrone2.children[g].quaternion.y,r.exdrone2.children[g].quaternion.z,r.exdrone2.children[g].quaternion.w),we.visible=!0,r.exdrone3.children.push(we),r.exdrone3.userData.active=!0,r.exdrone2.children[g].geometry.dispose(),r.exdrone2.children[g].material.materials[0].dispose(),r.exdrone2.children[g].material.materials[1].dispose(),r.exdrone2.remove(r.exdrone2.children[g]),g--}r.exdrone2.userData.active=!1}if(r.exdrone1.userData.active){for(var g=r.exdrone1.children.length-1;g>0;){var we=r.exdrone2.children[0].clone();we.position.set(r.exdrone1.children[g].position.x,r.exdrone1.children[g].position.y,r.exdrone1.children[g].position.z),we.quaternion.set(r.exdrone1.children[g].quaternion.x,r.exdrone1.children[g].quaternion.y,r.exdrone1.children[g].quaternion.z,r.exdrone1.children[g].quaternion.w),we.visible=!0,r.exdrone2.children.push(we),r.exdrone2.userData.active=!0,r.exdrone1.children[g].geometry.dispose(),r.exdrone1.children[g].material.materials[0].dispose(),r.exdrone1.children[g].material.materials[1].dispose(),r.exdrone1.remove(r.exdrone1.children[g]),g--}r.exdrone1.userData.active=!1}for(var De,ze,Me="shp1",Be="dphaser",_e=p.contacts;null!==_e;)null!=_e.body1&&null!=_e.body2&&(De=_e.body1.name||" ",ze=_e.body2.name||" ",(De==Me&&ze==Be||ze==Me&&De==Be)&&(w[0].r1-=1,0===w[0].r1&&q.handlerespawn())),_e=_e.next;for(var g=0;g<r.grouppart.children.length;g++)if(f-r.grouppart.children[g].userData.timecreated>8e-4)r.grouppart.children[g].geometry.dispose(),r.grouppart.children[g].material.dispose(),r.grouppart.remove(r.grouppart.children[g]);else{for(var je=r.grouppart.children[g].geometry.vertices,qe=0;qe<je.length;qe++)r.grouppart.children[g].geometry.vertices[qe].x+=10*Math.random(),r.grouppart.children[g].geometry.vertices[qe].y+=10*Math.random(),r.grouppart.children[g].geometry.vertices[qe].z+=10*Math.random();r.grouppart.children[g].geometry.verticesNeedUpdate=!0}for(var g=ce.length;g--;)if(f-ce[g].userData.timecreated>8e-4){for(var Ie=ce[g].children,Ve=Ie.length;Ve--;)Ie[Ve].material.dispose,Ie[Ve].geometry.dispose,ce[g].remove(Ie[Ve]);i.scene.remove(ce[g]),ce.splice(g,1)}else for(var Ie=ce[g].children,qe=0;qe<Ie.length;qe++)Ie[qe].position.x+=me[qe].x,Ie[qe].position.y+=me[qe].y,Ie[qe].position.z+=me[qe].z;for(var Ee,Se,g=w.length;g--;){if(Se=w[g],Ee=z[g],i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value>y&&Y>0&&(t.respawn.firepx=1,q.planetex(),q.handlerespawn()),Ee.name.match("ast")){if(Ee.userData.atbd){i.playastex();var Ge;if(Ge="Group"==Ee.type?d.breakDown(Ee,Se):0)for(var Pe=0;Pe<Ge.length;Pe++){r.asteroids.add(Ge[Pe]),w[D]=new e.Body({move:!0,name:Ge[Pe].name,noSleep:!0,size:[30,30,30],pos:[Ge[Pe].position.x,Ge[Pe].position.y,Ge[Pe].position.z],type:"cylinder",world:p}),D++,z.push(Ge[Pe]),r.raycastarr.push(Ge[Pe]);var Re=Math.random();if(Pe&&(Re*=-1),w[D-1].body.linearVelocity.set(Re,Re,Re),w[D-1].body.newRotation.set(Re,Re,Re),1===Ee.children.length){var Oe=Ee.children[0];Oe.position.set(Ee.x,Ee.y,Ee.z),i.scene.add(Oe),i.scene.remove(Ee),z[g]=Oe,Se.name=Ee.name,r.asteroids.add(z[g])}}if(0===Ge){w.splice(g,1),z.splice(g,1),Ee.geometry.dispose(),Ee.material.dispose(),r.asteroids.remove(Ee);for(var ke=0;ke<r.raycastarr.length;ke++)r.raycastarr[ke].name==Ee.name&&r.raycastarr.splice(ke,1);D-=1,p.removeRigidBody(Se.body);var Te=l.create();Te.position.copy(Ee.position),Te.name="pex",Te.userData.timecreated=f,i.scene.add(Te),ce.push(Te);var Fe=i.scene.children[r.mesharrpos.gs].children[0].clone();Fe.position.copy(Ee.position),Fe.visible=!0,Fe.userData.timealive=0,i.scene.children[r.mesharrpos.gs].add(Fe)}}if(!i.boxworld.containsPoint(Ee.position)){var Le=Se.body.position;Le.multiplyScalar(-1);for(var Ce=["x","y","z"],He=3;He--;)(Le[Ce[He]]>150||Le[Ce[He]]<-150)&&(Le[Ce[He]]<0?Le[Ce[He]]=-149:Le[Ce[He]]=149);Ee.position.copy(Le).multiplyScalar(100),console.log("outside world")}}if("phaser"!=Ee.name&&"dphaser"!=Ee.name||(Ee.userData.timealive?(f-Ee.userData.timealive>.006&&"dphaser"==Ee.name&&a.push(w[g].body.shapes.id),f-Ee.userData.timealive>615e-6&&"phaser"==Ee.name&&a.push(w[g].body.shapes.id)):Ee.userData.timealive=f),Ee.userData.tbd<0&&(Ee.userData.tbd+=1,0===Ee.userData.tbd&&Se.disabled&&(Se.disabled=0)),!Se.getSleep()&&(Ee.position.copy(Se.getPosition()),Ee.quaternion.copy(Se.getQuaternion()),"shp1"==Se.name)){h.set(m.position.x,m.position.y,m.position.z),m.position.set(Ee.position.x,Ee.position.y,Ee.position.z);var Ae=m.position.x-h.x,Ne=m.position.y-h.y,Ue=m.position.z-h.z;i.camera.position.x+=Ae,i.camera.position.y+=Ne,i.camera.position.z+=Ue}if(ne>=oe)for(var Qe=1;Qe;)"drone"!=w[Qe].name||w[Qe].ld||w[Qe].nrtm||(S?w[Qe].ld=1:w[Qe].ld=2,w[Qe].nrtm=1,ie.push({id:w[Qe].id+"6666",ld:w[Qe].ld,body:{position:{x:w[Qe].body.position.x,y:w[Qe].body.position.y,z:w[Qe].body.position.z},linearVelocity:{x:0,y:0,z:0}}}),Qe=0,ne=0),Qe==w.length-1&&(Qe=0,ne=-1),Qe>0&&Qe<w.length&&(Qe+=1);if(a.indexOf(Se.body.shapes.id)!=-1||1==Ee.userData.tbd||Se.tbd)if(ge=0,Se.tbd&&(Ee.userData.tbd=1,ge=1),Ee.userData.tbd&&!Se.tbd&&ie.push({id:Se.id+"9999",ld:Se.ld,body:{position:{x:Se.body.position.x,y:Se.body.position.y,z:Se.body.position.z},linearVelocity:{x:0,y:0,z:0}}}),Se.tbd&&(Se.tbd=0,(S&&1===Se.ld||!S&&2===Se.ld)&&Se.nrtm&&ie.push({id:Se.id+"7777",ld:Se.ld,body:{position:{x:Se.body.position.x,y:Se.body.position.y,z:Se.body.position.z},linearVelocity:{x:0,y:0,z:0}}})),Ee.userData.tbd&&(ue.subVectors(m.position,Ee.position),ue.x>2e3||ue.y>2e3||ue.z>2e3?i.playDroneEx(1):i.playDroneEx(0)),Se.ld&&Se.nrtm)if(S&&1===Se.ld||!S&&2===Se.ld){"ms1"==Se.ms&&(ve.pos=[i.ms1pos.x,i.ms1pos.y,i.ms1pos.z]),"ms2"==Se.ms&&(ve.pos=[i.ms2pos.x,i.ms2pos.y,i.ms2pos.z]),q.loadExdrone(Ee);var We=q.dronePos(ve);Se.body.position.set(We[0]/100,We[1]/100,We[2]/100),Ee.userData.tbd=-5}else q.loadExdrone(Ee),Se.body.position.set(2e4,1e4,1e4),ge?Ee.userData.tbd=-5:(Ee.userData.tbd=-300,Se.disabled=1);else{w.splice(g,1),z.splice(g,1);var Je=Ee.geometry,Ge=Ee.material;Je.dispose(),"undefined"==typeof Ge.dispose?(q.loadExdrone(Ee),Ge.materials[0].dispose(),Ge.materials[1].dispose(),i.scene.children[i.dronenum].remove(Ee),J-=1,D-=1):(Ge.dispose(),"phaser"==Ee.name&&i.scene.children[r.mesharrpos.phasers].remove(Ee),(Ee.name="dphaser")&&(i.scene.children[r.mesharrpos.dphasers].remove(Ee),D--,M--)),p.removeRigidBody(Se.body)}if(f-Ee.userData.color>5e-4&&f-Ee.userData.color<.001&&(Ee.children[0].material.color.setRGB(.64,.64,.64),Ee.userData.color=0),"ms1"==Ee.name||"ms2"==Ee.name){if((3===b||6===b)&&"ms1"==Ee.name){Se.body.position.x>50&&(he=-.05,ye=-.1),Se.body.position.x<-50&&(he=.05,ye=-.1),A.copy(Se.body.position),Se.body.position.x+=he,Se.body.position.y=0,Se.body.position.z=(ye*Math.pow(Se.body.position.x,2)+50)/2;var fe=i.msla(Se.body);Se.body.setQuaternion(fe);var Xe=4,c=i.tvec();for(U=c.subVectors(i.planetpos,i.scene.children[i.ms1arrpos].position).length(),U-=Z,N.subVectors(A,Se.body.position),i.ms1pos.copy(Ee.position);Xe--;)r.ms1phaser.children[Xe]&&(20*r.ms1phaser.children[Xe].scale.z<U?(r.ms1phaser.children[Xe].scale.z+=.5,r.ms1phaser.children[Xe].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0,20*r.ms1phaser.children[Xe].scale.z>U&&(r.ms1phaser.children[Xe].scale.z-=.5,r.ms1phaser.children[Xe].position.z-=5))}var Ke=t.gcd("ms1y");if(Ke.y&&(i.ms1y.y=1),de=Ke.t,"ms1"==Se.name)"ms1_4"!=Ee.userData.msname&&(j=T,i.ms1y.y&&(Ee.children[0].material.color.setRGB(255,255,0),Ee.userData.color=f,i.ms1y.y=0,de>=V&&99!==r.ms1_1arrpos&&(V+=I,z[g]=i.swapms(Ee))));else if("ms2_4"!=Ee.userData.msname){var Ye=t.gcd("ms2y");le=Ye.t,Ye.y&&(i.ms2y.y=1),j=F,i.ms2y.y&&(Ee.children[0].material.color.setRGB(255,255,0),Ee.userData.color=f,i.ms2y.y=0,le>=V&&99!==r.ms2_1arrpos&&(V+=I,z[g]=i.swapms(Ee,b)))}O.set(m.position.x,m.position.y,m.position.z),k.set(Ee.position.x,Ee.position.y,Ee.position.z);var Ze=k.x-O.x;Ze<4e3&&Ze>-4e3&&(Ze=(Ze+4e3)/8e3*100,j.style.left=Ze+"%");var $e=k.y-O.y;$e<4e3&&$e>-4e3&&($e=($e+4e3)/8e3*100,j.style.top=$e+"%");var er=i.getPlayerDir("forward",m.position),rr=i.tvec();rr.subVectors(k,O).normalize(),"ms1"==Se.name?C=Math.acos(er.dot(rr)):H=Math.acos(er.dot(rr));C<.7||H<.7?L.className="divGreen":L.className="divRed"}"meteor"==Se.name&&i.rotPlanetoid(Se,Ee)}Y>=0&&(P[settingsarr[1]]&&i.addForce(),P[settingsarr[2]]&&i.minusForce(),P[settingsarr[0]]&&i.phaser(),P[settingsarr[0]]||i.phaseroff(),i.updateSightPos()),Y<0&&(i.sight.material.transparent=!0,i.sight.material.opacity=0);for(var g=0;g<w.length;g++){var nr=w[g],sr=z[g];if("drone"==nr.name){if(nr.prevpos.x===nr.body.position.x&&nr.prevpos.y===nr.body.position.y&&nr.prevpos.z===nr.body.position.z&&0!==nr.ld&&10===_&&(nr.rtm=1,S?nr.ld=1:nr.ld=2),0===_&&nr.prevpos.set(nr.body.position.x,nr.body.position.y,nr.body.position.z),nr.ld&&(sr.userData.ld=nr.ld),sr.userData.ld&&(nr.ld=sr.userData.ld),nr.rtm&&(sr.userData.rtm=1,nr.rtm=2),sr.userData.ld)if(S&&2!=nr.ld||!S&&1!=nr.ld){var ar=i.updateDrones(nr,sr,nr.ms);ar&&(D++,M++),0==sr.userData.ld&&0==sr.userData.rtm&&(nr.rtm=0,nr.ld=0),sr.userData.rtm&&2!=nr.rtm&&(ie.push({id:nr.id+"8888",ld:nr.ld,body:{position:{x:nr.body.position.x,y:nr.body.position.y,z:nr.body.position.z},linearVelocity:{x:0,y:0,z:0}}}),nr.rtm=2),nr.rtm||sr.userData.tbd||ie.push(nr)}else sr.position.copy(nr.getPosition()),sr.lookAt(z[1].position);sr.userData.ld||sr.userData.rtm||(R.sub(m.position,z[g].position),R.length()<4500?S?sr.userData.ld=1:sr.userData.ld=2:(nr.body.linearVelocity.set(0,0,0),nr.body.angularVelocity.set(0,0,0),3!=b&&6!=b||nr.body.position.subEqual(N)))}}if(3!==b)for(var Xe=4;Xe--;)6!=b&&r.ms1phaser.children[Xe]&&(20*r.ms1phaser.children[Xe].scale.z<U?(r.ms1phaser.children[Xe].scale.z+=.5,r.ms1phaser.children[Xe].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0),r.ms2phaser.children[Xe]&&(20*r.ms2phaser.children[Xe].scale.z<Q?(r.ms2phaser.children[Xe].scale.z+=.5,r.ms2phaser.children[Xe].position.z+=5):i.scene.children[r.mesharrpos.planetGlow].material.visible=!0);E=P[32]?1:0,setTimeout(t.update(w[0].body.position,w[0].body.linearVelocity,z[0].quaternion,E,ie,i.ms1y,i.ms2y),0)}},threejsrender:function(){i.render(),i.controls.update(),requestAnimationFrame(q.threejsrender)},handlerespawn:function(){if(Y=-200,document.getElementById("respawnImg").style.display="block",99===r.ms1_1arrpos&&Y<0&&(0===r.ms2_1arrpos||99===r.ms2_1arrpos)){var e=b+1;document.getElementById("level"+e+"Img").style.display="none"}},planetex:function(){var e=l.create(!0,250);e.name="pex",e.userData.timecreated=f+.001;for(var n=i.scene.children[r.mesharrpos.pl].children,s=0;s<n.length;s++)n[s].name==G&&(n[s].material.visible=!1,e.position.copy(n[s].position));document.getElementById("respawnImg").style.display="block",ce.push(e),i.scene.add(e)},populate:function(n){var s,a,o,l,c,m,h;a=0,l=0,o=0,c=m=h=30;var u=[],v=[];J=0,x&&(u=[{type:"sphere",size:[B,B,B],pos:[0,0,0],move:!0,noSleep:!0,world:p,color:16777215,wireframe:"false",name:"shp1",transparent:"true",opacity:0,image:"cpv/cpvLge.obj",mtl:"cpv/cpv.mtl"},{type:"sphere",size:[8,8,8],pos:[0,0,0],move:!0,world:p,color:"#ff0000",wireframe:"false",name:"containerMesh",transparent:"false",opacity:1,image:0}],i.addLine(),i.addPlane("planetGlow")),x||(r.startRender+=1);for(var g=0;W[g];)n[W[g]]&&(n[W[g]].new=0),g++;this.levelobj=n,pe=this.levelobj.numofast,y=this.levelobj.pex_t,I=this.levelobj.dow,V=I;for(s in this.levelobj){if("p"==s.charAt(0)&&"pglowt"!=s&&"pex_t"!=s){if("planet1"==s){Z=this.levelobj[s].size[0]/2;var f=this.levelobj[s].pos;i.planetpos.set(f[0],f[1],f[2])}0!==this.levelobj[s]&&u.push(this.levelobj[s])}"m"==s.charAt(0)&&0!==this.levelobj[s]&&v.push(this.levelobj[s]),"drone"==s&&(J=this.levelobj[s],K=this.levelobj[s])}for(var g=i.scene.children[r.mesharrpos.pl].children.length;g--;)$.indexOf(i.scene.children[r.mesharrpos.pl].children[g].name)!=-1&&(i.scene.children[r.mesharrpos.pl].children[g].material.visible=!1);for(var g=w.length;g--;)$.indexOf(w[g].name)!=-1&&(p.removeRigidBody(w[g].body),w.splice(g,1),D-=1);for(var g=0;g<u.length;g++){if("containerMesh"!=u[g].name){if("planet"==u[g].class&&u[g].name.match("1")&&(i.scene.children[r.mesharrpos.planetGlow].position.set(u[g].pos[0],u[g].pos[1],u[g].pos[2]),i.scene.children[r.mesharrpos.planetGlow].material.uniforms.glowFloat.value=this.levelobj.pglowt,G=u[g].name),u[g].world=p,w[D]=new e.Body(u[g]),"planet"==u[g].class&&w[D].body.sleep(),$.indexOf(u[g].name)!=-1){var f=$.indexOf(u[g].name),z=i.scene.children[r.mesharrpos.pl].children[f];z.material.visible=!0,z.position.set(u[g].pos[0],u[g].pos[1],u[g].pos[2]),"RawShaderMaterial"==z.material.type&&(z.material.uniforms.colvar1.value=Math.random(),z.material.uniforms.colvar2.value=Math.random(),z.material.needsUpdate=!0)}$.indexOf(u[g].name)==-1&&(i.addSphere(u[g]),"shp1"!=u[g].name&&$.push(u[g].name)),"shp1"==w[D].name&&(x&&(w[D].r1=1500),i.setBodys(w[D])),D+=1}"containerMesh"==u[g].name&&i.addSphere(u[g])}var M=v.length;for(ae=[];M--;)ae.push(v[M].name),W.indexOf(v[M].name)===-1&&W.push(v[M].name);for(var g=0;g<W.length;g++)if(void 0!=v[g]&&v[g].new){i.addBox(v[g]),i.addBox({type:"box",pos:v[g].pos,world:"world",name:v[g].name+"_1",msname:v[g].name+"_1",image:"ms/"+v[g].name+"_1.obj",mtl:"ms/"+v[g].name+".mtl"}),v[g].new=0;var _={type:"cylinder",name:"ms"+(g+1)+"phaser",color:39423};i.addCylinder(_);var j;j="ms1"==v[g].msname?T:F,v[g].pos[0]>0?j.style.left="100%":j.style.left="0"}else for(var q=i.scene.children.length;q--;)if(i.scene.children[q].name.substr(0,3)==W[g])if(i.scene.children[q].userData.msname==W[g]){if(ae.indexOf(i.scene.children[q].userData.msname)!=-1?(i.scene.children[q].children[0].material.transparent=!1,i.scene.children[q].children[0].material.opacity=1,i.scene.children[q].position.set(v[g].pos[0],v[g].pos[1],v[g].pos[2]),i.scene.children[q].name=i.scene.children[q].userData.msname,r.startRender+=1):(i.scene.children[q].children[0].material.transparent=!0,i.scene.children[q].children[0].material.opacity=0,i.scene.children[q].name=i.scene.children[q].userData.msname),"ms1"==i.scene.children[q].userData.msname)var E=r.ms1phaser.children,_=r.ms1phaser;if("ms2"==i.scene.children[q].userData.msname)var E=r.ms2phaser.children,_=r.ms2phaser;for(var S=E.length;S--;){var P=E[S].geometry,R=E[S].material;P.dispose(),R.dispose(),_.remove(E[S])}if(ae.indexOf(i.scene.children[q].userData.msname)!=-1){i.scene.children[q].children[0].remove(_);var O=i.scene.children[q].userData.msname,_={type:"cylinder",name:O+"phaser",color:39423};i.addCylinder(_)}}else i.scene.children[q].children[0].material.transparent=!0,i.scene.children[q].children[0].material.opacity=0,v[g]&&i.scene.children[q].position.set(v[g].pos[0],v[g].pos[1],v[g].pos[2]),i.scene.children[q].name=i.scene.children[q].userData.msname;for(var k=0;k<v.length;k++)v[k].world=p,w[D]=new e.Body(v[k]),w[D].name=v[k].msname,D+=1;for(var L=0,C=[i.planetpos,i.tvec(v[0].pos[0],v[0].pos[1],v[0].pos[2]),i.tvec(0,0,0)],H=[9,7,5,3,2],q=0;q<pe;q++){var A=d.create(H[L]);A.name="astgroup"+q;var a=this.randMinMax(-15e3,15e3),o=this.randMinMax(-15e3,15e3),l=this.randMinMax(-15e3,15e3);A.position.set(a,o,l),i.scene.add(A),w[D]=new e.Body({move:!0,name:"astgroup"+q,noSleep:!0,size:[70,50],pos:[a,o,l],type:"cylinder",world:p,density:1e3}),D++;var N=i.tvec();Math.random();N.subVectors(A.position,C[this.randMinMax(0,2)]).normalize();var U=this.randMinMax(-20,-30);N.multiplyScalar(U),w[D-1].body.linearVelocity.addTime(N,p.timeStep),w[D-1].body.angularVelocity.set(Math.random(),Math.random(),Math.random(),Math.random()),0!==r.asteroids.children.length&&r.asteroids.children.length%10==0&&L++,r.asteroids.add(A)}x&&i.scene.add(r.asteroids),r.raycastarr.push(r.asteroids);var a,o,Q=[],Y=0,ee=v.length,ne=0,l=0;if(1===b)var se=8;else var se=Math.round(J/(4*ee));if(0!=X){for(var oe=i.scene.children[i.dronenum].children.length-1;oe>J;){var P=i.scene.children[i.dronenum].children[oe].geometry,R=i.scene.children[i.dronenum].children[oe].material;i.scene.children[i.dronenum].remove(i.scene.children[i.dronenum].children[oe]),oe-=1}for(var g=0;g<i.scene.children[i.dronenum].children.length;g++)i.scene.children[i.dronenum].children[g].userData.ld=0;for(var g=w.length-1;g--&&X>J;)"drone"==w[g].name&&(w.splice(g,1),D--,X--);J-=X;for(var g=w.length;g--;)if("drone"==w[g].name){var f=this.dronePos(v[0]);w[g].body.position.set(f[0]/100,f[1]/100,f[2]/100),w[g].ld=0,w[g].nrtm=0,w.push(w.splice(g,1)[0])}}x||J--;for(var g=0;g<=J;g++)if(ne<=J/ee){var f=this.dronePos(v[Y]),ie={type:"cylinder",size:[c,m,h],pos:f,move:!0,world:p,noSleep:!1,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};0==g&&x?ie.pos=[1e4,1e4,1e4]:(w[D]=new e.Body(ie),w[D].id=0,w[g].rtm=0,w[D].ms=v[Y].msname,w[D].tbd=0,w[D].disabled=0,w[D].prevpos=new e.Vec3(w[D].body.position.x,w[D].body.position.y,w[D].body.position.z),se&&(w[D].ld=0,w[D].nrtm=0,se-=1),se||(w[D].ld=0,w[D].nrtm=0),D+=1,ne+=1),Q.push(ie)}else{Y+=1,ne=0,se=Math.round(J/(4*ee));var f=this.dronePos(v[Y]),ie={type:"cylinder",size:[c,m,h],pos:f,move:!0,world:p,noSleep:!1,color:"#66ff33",wireframe:"false",name:"drone",transparent:"false",opacity:1,image:"Free_Droid/bake.obj"};w[D]=new e.Body(ie),w[D].id=0,w[D].ms=v[Y].msname,w[D].tbd=0,w[D].prevpos=new e.Vec3(w[D].body.position.x,w[D].body.position.y,w[D].body.position.z),D+=1,Q.push(ie)}if(x){i.addCylinder(Q);for(var te=[{type:"cylinder",move:"true",world:p,name:"exdrone1",transparent:"false",opacity:1,image:"ani/exdrone1.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:p,name:"exdrone2",transparent:"false",opacity:1,image:"ani/exdrone2.obj",mtl:"images/ani/BaseMaterial_normal.png"},{type:"cylinder",move:"true",world:p,name:"exdrone3",transparent:"false",opacity:1,image:"ani/exdrone3.obj",mtl:"images/ani/BaseMaterial_normal.png"}],g=0;g<te.length;g++)i.addCylinder(te[g]);J-=1;var de={type:"sphere",move:"true",world:p,name:"dphasers",transparent:"false",opacity:1,image:"phasers/dphaser.obj",texture:"images/phasers/bluefire.png"};i.addSphere(de),i.addPlane("laser")}else{r.startRender+=6;for(var g=0;g<i.scene.children.length;g++)if("drones"==i.scene.children[g].name)for(var q=Q.length;q--;){var le=i.scene.children[g].children[0].clone();le.position.set(Q[q].pos[0],Q[q].pos[1],Q[q].pos[2]),i.scene.children[g].add(le)}}X&&(J+=X),re=v.length+7,x&&this.render(),t.firstStream=1,t.startgame=2},dronePos:function(e){var r=this.randMinMax(-1e3,1e3),n=this.randMinMax(-1e3,1e3),s=this.randMinMax(-1e3,1e3);return r+=e.pos[0],n+=e.pos[1],s+=e.pos[2],[r,n,s]},loadExdrone:function(e){r.exdrone1.userData.active=!0;var n=r.exdrone1.children[0].clone();n.position.set(e.position.x,e.position.y,e.position.z),n.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),n.visible=!0,r.exdrone1.children.push(n)},expartfunc:function(e){for(var n=i.expart(),s=0;s<n.geometry.vertices.length;s++)n.geometry.vertices[s].x=e.x,n.geometry.vertices[s].y=e.y,n.geometry.vertices[s].z=e.z;n.userData.timecreated=f,r.grouppart.add(n)},getObj:function(e){switch(e){case"bodys":return w;case"containerMesh":return m;case"host":return S;case"shp1r":return B;case"v3d":return i;case"world":return p;case"keys":return P;case"x982y":return b;case"endsequence":return Y}},randMinMax:function(e,r){return Math.floor(Math.random()*(r-e+1))+e},isSleeping:function(e){for(var r=0;r<w.length;r++)if(w[r].name==e)return w[r].getSleep()},gspause:function(e){return void 0==e?o:void(o=e)},removegeomat:function(e){if(0!==e.children.length)for(var r=e.children.length;r--;)this.removegeomat(e.children[r]),e.remove(e.children[r]);else"Mesh"==e.type&&(e.geometry.dispose(),e.material.dispose())},levelGen:function(e){e?b=1:b+=1,t.firstStream=2,t.server_updates=[],t.ms1y={y:0,t:1},t.ms2y={y:0,t:1},t.respawning||t.levelGen(b),t.respawning=0,t.respawn.firepx=0,r.x982y=b;for(var n=0;n<i.scene.children.length;n++)i.scene.children[n].userData.msname&&("ms1_4"==i.scene.children[n].userData.msname?i.scene.children[n].children[0].material.color.setRGB(0,0,0):i.scene.children[n].children[0].material.color.setRGB(.64,.64,.64));3===b||6===b?i.eg.material.visible=!0:i.eg.material.visible=!1,i.scene.children[r.mesharrpos.planetGlow].material.visible=!1,X=0;for(var n=w.length;n--;)"drone"==w[n].name&&(X+=1),("dphaser"==w[n].name||w[n].name.match("ast")||w[n].name.match("ms"))&&(p.removeRigidBody(w[n].body),w.splice(n,1),D-=1);for(this.removegeomat(r.asteroids);null!==p.contacts;)p.removeContact(p.contacts);for(var n=r.dphasers.children.length-1;n>0;){var s=r.dphasers.children[n].material,a=r.dphasers.children[n].geometry;a.dispose(),s.dispose(),r.dphasers.remove(r.dphasers.children[n]),n--}x=0,i.ms1y.y=0,i.ms2y.y=0,ne=0,e&&(w[0].r1=1500),r.startRender=0,r.raycastarr=[],r.ms1_1arrpos=0,r.ms2_1arrpos=0,D=w.length,z=[],M=0,m=0,oe-=10,de=1,le=1,this.lgd(b),Y=100,e?(document.getElementById("respawnImg").style.display="none",document.getElementById("respawntxt").innerHTML="",i.sight.material.transparent=!1,i.sight.material.opacity=1,oe=60):document.getElementById("level"+b+"Img").style.display="none",S?(w[0].body.position.set(0,0,0),w[1].body.position.set(.2,0,-1),w[1].body.sleepPosition.set(.2,0,-1)):(w[0].body.position.set(.2,0,-1),w[1].body.position.set(0,0,0),w[1].body.sleepPosition.set(0,0,0))},lgd:function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==this.readyState&&200==this.status&&q.populate(JSON.parse(this.responseText))},r.open("POST",url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("l="+e)}}}});