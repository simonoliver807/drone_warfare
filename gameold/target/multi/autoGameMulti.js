define(["multi/gameinitmulti","v3d"],function(e,n){"use strict";return function(){var t,i,r=new e,o=1/60;return{init:function(){function e(e){if(80===e.keyCode){var n=r.gspause()?0:1;r.gspause(n)}70==e.keyCode&&document.body.webkitRequestFullScreen()}function a(){if(!h.shp1){var e=r.getObj("bodys");if(e.length>1)for(var n=0;n<e.length;n++)if("shp1"==e[n].name){h.shp1=e[n].body;break}}if(!h.dnum)for(var n=0;n<t.scene.children.length;n++)"drones"==t.scene.children[n].name&&(h.dnum=n);h.shp1&&h.dnum&&c()}function s(){t.camera.aspect=window.innerWidth/window.innerHeight,t.camera.fov=360/Math.PI*Math.atan(t.tanFOV*(window.innerHeight/window.innerHeight)),t.camera.updateProjectionMatrix(),t.renderer.setSize(window.innerWidth,window.innerHeight),t.h=window.innerHeight,t.w=window.innerWidth}function c(){function e(){for(var e=r.getObj("bodys"),n=t.tvec(),o=0,a=0;a<e.length;a++){if(e[a].name.match("ms"))for(var s=t.scene.children.length;s--;)if(t.scene.children[s].name==e[a].name)if(0===t.scene.children[s].children[0].children[0].children.length)c=0,console.log("ms undefined in autogame");else var c=1;if("drone"==e[a].name||e[a].name.match("ms")&&c){n.subVectors(h.shp1.position,e[a].body.position);var d=n.length();if(d<o||0===o){if(o=d,h.tarvec.set(e[a].body.position.x,e[a].body.position.y,e[a].body.position.z),h.tarvec.multiplyScalar(100),"drone"==e[a].name&&!h.notDrone)for(var l=0;l<t.scene.children[h.dnum].children.length;l++){var m=t.scene.children[h.dnum].children[l];h.tarvec.equals(m.position)&&(h.setld&&!e[a].ld&&(e[a].ld=h.setld),(h.notpl2&&e[a].ld===i||!h.notpl2)&&(h.tarbody=m))}if("drone"==e[a].name&&h.notDrone&&(o=0),e[a].name.match("ms")&&!h.notMS)for(var p=0;p<t.scene.children.length;p++){var v=t.scene.children[p];v.name==e[a].name&&(h.tarbody=v)}e[a].name.match("ms")&&h.notMS&&(o=0)}}}}function o(e,n,i){if(e){var r=t.tvec(),o=.5*t.w,a=.5*t.h;e.updateMatrixWorld(),r.setFromMatrixPosition(e.matrixWorld)}if(i){var r=t.tvec(),o=.5*t.w,a=.5*t.h;r.set(i.x,i.y,i.z)}return r.project(n),r.x=r.x*o+o,r.y=-(r.y*a)+a,{x:r.x,y:r.y}}function a(){h.tarvec=t.tvec(),h.tarbody=0,h.chngdir=0,h.chngdiry=0,h.angleprev=0,h.setAxis=1,h.lockcount=0,h.retargetCnt=0,h.bincount=0}var s=r.getObj("endsequence");if(s<100)a();else{var c=r.getObj("containerMesh");if(c){var d=r.getObj("keys");if(d[32]||(d[32]=1),h.host=r.getObj("host"),i=h.host?1:2,99==h.chngdir){var l=0;if("drone"==h.tarbody.name)for(var m=0;m<t.scene.children[h.dnum].children.length;m++)h.tarbody.id==t.scene.children[h.dnum].children[m].id&&(l=1);if(h.tarbody.name.match("ms"))for(var m=0;m<t.scene.children.length;m++)if(h.tarbody.userData.msname==t.scene.children[m].userData.msname){if(t.scene.children[m].children[0].children[0])var p=t.scene.children[m].children[0].children[0].children.length;p&&(l=1)}l||a(),h.retargetCnt++}if(h.pl2tpl1&&0===h.host)for(var m=0;m<t.scene.children.length;m++)if("player2"==t.scene.children[m].name){h.tarbody=t.scene.children[m];break}if(h.host||(h.notDrone=0,h.notMS=1,h.notpl2=0,h.pl2tpl1=0,h.setpl2rev&&(h.lv=-200)),h.host&&(h.notDrone=1,h.notMS=0,h.notpl2=0),0===h.tarbody&&e(),100!=h.retargetCnt||h.pl2tpl1||(e(),h.retargetCnt=0),3==h.bincount){h.shp1.linearVelocity.set(0,0,0);var v=t.tvec(h.tarbody.position.x,h.tarbody.position.y,h.tarbody.position.z);v.normalize(),v.multiplyScalar(h.lv),h.shp1.linearVelocity.addTime(v,h.timestep),h.bincount=0}else h.bincount++;var g=t.tvec();g.subVectors(t.sight.position,t.containerMesh.position).normalize();var y=t.tvec();if(0!=h.tarbody){if(h.tarbody.name.match("ms1")&&3===n.x982y)for(var m=0;m<t.scene.children.length;m++)"ms1"==t.scene.children[m].name&&h.tarbody.position.copy(t.scene.children[m].position);y.subVectors(h.tarbody.position,t.containerMesh.position).normalize();var u=g.dot(y);u=Math.acos(u);var f=t.tvec();f.crossVectors(g,y),0==h.chngdir&&(f.y<0&&(h.chngdir=-1),f.y>0&&(h.chngdir=1)),99!=h.chngdir&&(h.chngdir>0&&f.y<0&&(h.chngdir=99),h.chngdir<0&&f.y>0&&(h.chngdir=99));var b,w,x=t.w/100*5,M=t.h/100*5,k=t.w/100*10,S=t.h/100*10,j=t.w-x,z=x,V=t.h-M,O=M,C=t.w-k,D=k;t.h-S;if(f.y>0&&(h.setAxis=1),f.y<0&&(h.setAxis=-1),h.x<j&&h.x>z&&(h.x<C&&h.x>D?1==h.setAxis?h.x-=100:h.x+=100:1==h.setAxis?h.x-=20:h.x+=20),!n.bincam){var A=o(h.tarbody,t.camera),R=o(t.sight,t.camera);n.clientx=R.x,n.clienty=R.y}if(n.bincam){var W=t.tvec(),H=t.tvec();W.subVectors(h.tarbody.position,t.containerMesh.position).normalize(),W.multiplyScalar(90),H.addVectors(W,t.containerMesh.position);var A=o(0,t.camera,H);o(h.tarbody,t.camera,0)}var P=h.angleprev-u;P<0&&(P*=-1),99==h.chngdir&&(h.x=A.x),0!=h.angleprev&&(P>=0&&P<.002||h.angleprev<u)&&(h.y=A.y)}n.bincam&&99==h.chngdir&&(10==h.lockcount&&(h.arrposcnt<h.arrpos.length?(h.x+=h.arrpos[h.arrposcnt],h.y+=h.arrpos[h.arrposcnt+1],h.arrposcnt+=2):(h.arrposcnt=0,h.lockcount=0)),h.lockcount<10&&(h.lockcount+=1)),b=h.x,w=h.y,n.msePos.set(b/t.w*2-1,2*-(w/t.h)+1,.5),n.pageX=b,n.pageY=w,b>j?t.startRot=1:b<z?t.startRot=1:w>V?t.startRot=1:w<O?t.startRot=1:t.startRot=0,h.angleprev=u}}}window.oncontextmenu=function(){return!1},window.addEventListener("resize",s,!1),window.addEventListener("keydown",e,!1),t=r.getObj("v3d"),r.createWorld(o),r.lgd(1),t.initLight(),t.initPoints(),this.x=t.w/2,this.y=t.h/2,this.shp1=0,this.tarvec=t.tvec(),this.tarbody=0,this.chngdir=0,this.chngdiry=0,this.angleprev=0,this.setAxis=1,this.timestep=o,this.lockcount=0,this.arrpos=[1,0,1,1,0,1,-1,0,-1,-1,0,-1,-1,1,1,-1,2,0,2,2,0,2,-2,0,-2,-2,0,-2,-2,2],this.arrposcnt=0,this.bincount=0,this.retargetCnt=0,this.notDrone=0,this.notMS=1,this.notpl2=1,this.pl2tpl1=0,this.setld=0,this.setpl2rev=1,this.lv=200,this.dnum;var h=this;this.host=0,this.player=0,this.ms1d=0,this.ms2d=0,setInterval(a,10)}}}});