define(["gameinit","v3d"],function(e,n){"use strict";return function(){var t,i=new e,r=1/60;return{init:function(){function e(e){if(80===e.keyCode){var n=i.gspause()?0:1;i.gspause(n)}70==e.keyCode&&document.body.webkitRequestFullScreen()}function a(){if(s.shp1)c();else{var e=i.getObj("bodys");if(e.length>1)for(var n=0;n<e.length;n++)"shp1"==e[n].name&&(s.shp1=e[n].body)}}function o(){t.camera.aspect=window.innerWidth/window.innerHeight,t.camera.fov=360/Math.PI*Math.atan(t.tanFOV*(window.innerHeight/window.innerHeight)),t.camera.updateProjectionMatrix(),t.renderer.setSize(window.innerWidth,window.innerHeight),t.h=window.innerHeight,t.w=window.innerWidth}function c(){function e(){for(var e=i.getObj("bodys"),n=t.tvec(),r=0,a=0;a<e.length;a++){if(e[a].name.match("ms"))for(var o=t.scene.children.length;o--;)if(t.scene.children[o].name==e[a].name)if(0===t.scene.children[o].children[0].children[0].children.length)c=0;else var c=1;if("drone"==e[a].name||e[a].name.match("ms")&&c){n.subVectors(s.shp1.position,e[a].body.position);var d=n.length();if(d<r||0===r){if(r=d,s.tarvec.set(e[a].body.position.x,e[a].body.position.y,e[a].body.position.z),s.tarvec.multiplyScalar(100),"drone"==e[a].name&&!s.notDrone)for(var h=0;h<t.scene.children[s.dnum].children.length;h++){var l=t.scene.children[s.dnum].children[h];s.tarvec.equals(l.position)&&(s.tarbody=l)}if("drone"==e[a].name&&s.notDrone&&(r=0),e[a].name.match("ms")&&!s.notMS)for(var m=0;m<t.scene.children.length;m++){var v=t.scene.children[m];v.userData.msname==e[a].name&&(s.tarbody=v)}e[a].name.match("ms")&&s.notMS&&(r=0)}}}}function r(e,n,i){if(e){var r=t.tvec(),a=.5*t.w,o=.5*t.h;e.updateMatrixWorld(),r.setFromMatrixPosition(e.matrixWorld)}if(i){var r=t.tvec(),a=.5*t.w,o=.5*t.h;r.set(i.x,i.y,i.z)}return r.project(n),r.x=r.x*a+a,r.y=-(r.y*o)+o,{x:r.x,y:r.y}}function a(){s.tarvec=t.tvec(),s.tarbody=0,s.chngdir=0,s.chngdiry=0,s.angleprev=0,s.setAxis=1,s.lockcount=0,s.retargetCnt=0,s.bincount=0}var o=i.getObj("endsequence");if(o<100)a();else{var c=i.getObj("containerMesh");if(c){var d=i.getObj("keys");if(d[32]||(d[32]=1),99==s.chngdir){var h=0;if("drone"==s.tarbody.name)for(var l=0;l<t.scene.children[s.dnum].children.length;l++)s.tarbody.id==t.scene.children[s.dnum].children[l].id&&(h=1);if(s.tarbody.name.match("ms"))for(var l=0;l<t.scene.children.length;l++)if(s.tarbody.userData.msname==t.scene.children[l].userData.msname){if(t.scene.children[l].children[0].children[0])var m=t.scene.children[l].children[0].children[0].children.length;m&&(h=1)}h||a(),s.retargetCnt++}if(0==s.tarbody&&e(),100==s.retargetCnt&&(e(),s.retargetCnt=0),3==s.bincount){s.shp1.linearVelocity.set(0,0,0);var v=t.tvec(s.tarbody.position.x,s.tarbody.position.y,s.tarbody.position.z);v.normalize(),v.multiplyScalar(s.lv),s.shp1.linearVelocity.addTime(v,s.timestep),s.bincount=0}else s.bincount++;var g=t.tvec();g.subVectors(t.sight.position,t.containerMesh.position).normalize();var y=t.tvec();if(0!=s.tarbody){y.subVectors(s.tarbody.position,t.containerMesh.position),y.normalize();var u=g.dot(y);u=Math.acos(u);var p=t.tvec();p.crossVectors(g,y),0==s.chngdir&&(p.y<0&&(s.chngdir=-1),p.y>0&&(s.chngdir=1)),99!=s.chngdir&&(s.chngdir>0&&p.y<0&&(s.chngdir=99),s.chngdir<0&&p.y>0&&(s.chngdir=99));var b,f,w=t.w/100*5,x=t.h/100*5,M=t.w/100*10,k=t.h/100*10,z=t.w-w,j=w,S=t.h-x,V=x,C=t.w-M,O=M;t.h-k;if(p.y>0&&(s.setAxis=1),p.y<0&&(s.setAxis=-1),s.x<z&&s.x>j&&(s.x<C&&s.x>O?1==s.setAxis?s.x-=100:s.x+=100:1==s.setAxis?s.x-=20:s.x+=20),!n.bincam){var A=r(s.tarbody,t.camera),D=r(t.sight,t.camera);n.clientx=D.x,n.clienty=D.y}if(n.bincam){var R=t.tvec();t.tvec();R.subVectors(s.tarbody.position,t.containerMesh.position).normalize(),R.multiplyScalar(90);var A=r(0,t.camera,R);r(s.tarbody,t.camera,0)}var W=s.angleprev-u;W<0&&(W*=-1),99==s.chngdir&&(s.x=A.x),0!=s.angleprev&&(W>=0&&W<.002||s.angleprev<u)&&(s.y=A.y)}n.bincam&&99==s.chngdir&&(10==s.lockcount&&(s.arrposcnt<s.arrpos.lenght?(s.x+=s.arrpos[s.arrposcnt],s.y+=s.arrpos[s.arrposcnt+1],s.arrposcnt+=2):(s.arrposcnt=0,s.lockcount=0)),s.lockcount<10&&(s.lockcount+=1)),b=s.x,f=s.y,n.msePos.set(b/t.w*2-1,2*-(f/t.h)+1,.5),n.pageX=b,n.pageY=f,b>z?t.startRot=1:b<j?t.startRot=1:f>S?t.startRot=1:f<V?t.startRot=1:t.startRot=0,s.angleprev=u}}}window.oncontextmenu=function(){return!1},window.addEventListener("resize",o,!1),window.addEventListener("keydown",e,!1),t=i.getObj("v3d"),i.createWorld(r),i.lgd(1),t.initLight(),t.initPoints(),this.x=t.w/2,this.y=t.h/2,this.shp1=0,this.tarvec=t.tvec(),this.tarbody=0,this.chngdir=0,this.chngdiry=0,this.angleprev=0,this.setAxis=1,this.timestep=r,this.lockcount=0,this.arrpos=[1,0,1,1,0,1,-1,0,-1,-1,0,-1,-1,1,1,-1,2,0,2,2,0,2,-2,0,-2,-2,0,-2,-2,2],this.arrposcnt=0,this.bincount=0,this.retargetCnt=0,this.notDrone=1,this.notMS=0,this.lv=200,n.bincam?this.dnum=7:this.dnum=8;var s=this;setInterval(a,10)}}}});